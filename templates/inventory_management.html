{% extends 'base.html' %}
{% block content %}
<section class="card">
  <div class="inventory-header">
    <h2>Gestão de Inventário</h2>
  </div>

  <div class="inventory-filters">
    <input id="filter-name" type="search" placeholder="Buscar por nome" />
    <select id="filter-category">
      <option value="">Todas categorias</option>
      {% for category in categories %}
      <option value="{{ category }}">{{ category }}</option>
      {% endfor %}
    </select>
    <select id="filter-status">
      <option value="">Todos status</option>
      <option value="ativo">Ativos</option>
      <option value="inativo">Inativos</option>
    </select>
  </div>

  <table class="stock-table" id="inventory-table">
    <thead><tr><th>Produto</th><th>Categoria</th><th>Estoque</th><th>Venda</th><th>Status</th><th>Ações</th></tr></thead>
    <tbody>
      {% for p in products %}
      <tr data-name="{{ p.name|lower }}" data-category="{{ p.category|lower }}" data-status="{{ 'ativo' if p.active else 'inativo' }}">
        <td>{{ p.name }}</td>
        <td>{{ p.category }}</td>
        <td>{{ p.stock }}</td>
        <td>R$ {{ '%.2f'|format(p.price) }}</td>
        <td>{{ 'Ativo' if p.active else 'Inativo' }}</td>
        <td>
          <button type="button" class="btn-secondary" data-open-modal="edit-product-modal-{{ p.id }}">Editar</button>
          {% if p.active %}
          <form method="post" action="{{ url_for('remover_produto', product_id=p.id) }}" class="inline-form">
            <button type="submit" class="btn-danger">Inativar</button>
          </form>
          {% else %}
          <form method="post" action="{{ url_for('ativar_produto', product_id=p.id) }}" class="inline-form">
            <button type="submit" class="btn-primary">Ativar</button>
          </form>
          {% endif %}
        </td>
      </tr>

      <dialog id="edit-product-modal-{{ p.id }}" class="modal">
        <div class="modal-content">
          <h3>Editar produto</h3>
          <form method="post" action="{{ url_for('editar_produto', product_id=p.id) }}" class="inline-form">
            <input name="name" value="{{ p.name }}" required />
            <select name="category" class="inventory-edit-category" data-target="edit-component-class-{{ p.id }}">
              <option value="Peça" {% if p.category == 'Peça' %}selected{% endif %}>Peça</option>
              <option value="Computador" {% if p.category == 'Computador' %}selected{% endif %}>Computador</option>
              <option value="Serviço" {% if p.category == 'Serviço' %}selected{% endif %}>Serviço</option>
              <option value="Periférico" {% if p.category == 'Periférico' %}selected{% endif %}>Periférico</option>
              <option value="Periféricos" {% if p.category == 'Periféricos' %}selected{% endif %}>Periféricos</option>
            </select>
            <div id="edit-component-class-{{ p.id }}" class="inventory-edit-class-wrapper" data-category-value="{{ p.category }}">
              <label for="edit-component-class-select-{{ p.id }}">Classe da peça</label>
              <select name="component_class" id="edit-component-class-select-{{ p.id }}">
                <option value="">Selecione a classe</option>
                {% for slot_key, slot_label, _ in component_slots %}
                <option value="{{ slot_key }}" {% if p.component_class == slot_key %}selected{% endif %}>{{ slot_label }}</option>
                {% endfor %}
              </select>
            </div>
            <input name="stock" type="number" min="0" value="{{ p.stock }}" required />
            <input name="cost_price" type="number" min="0" step="0.01" value="{{ p.cost_price }}" required />
            <input name="price" type="number" min="0" step="0.01" value="{{ p.price }}" required />
            <button type="submit" class="btn-primary">Salvar</button>
          </form>
          <button type="button" class="btn-secondary" data-close-modal="edit-product-modal-{{ p.id }}">Fechar</button>
        </div>
      </dialog>
      {% endfor %}
    </tbody>
  </table>
</section>


<script>
  (function () {
    const filterName = document.getElementById('filter-name');
    const filterCategory = document.getElementById('filter-category');
    const filterStatus = document.getElementById('filter-status');
    const rows = document.querySelectorAll('#inventory-table tbody tr');

    const applyFilters = () => {
      const name = (filterName.value || '').toLowerCase();
      const category = (filterCategory.value || '').toLowerCase();
      const status = (filterStatus.value || '').toLowerCase();

      rows.forEach((row) => {
        const matchesName = !name || row.dataset.name.includes(name);
        const matchesCategory = !category || row.dataset.category === category;
        const matchesStatus = !status || row.dataset.status === status;
        row.style.display = matchesName && matchesCategory && matchesStatus ? '' : 'none';
      });
    };

    [filterName, filterCategory, filterStatus].forEach((el) => el.addEventListener('input', applyFilters));

    document.querySelectorAll('[data-open-modal]').forEach((btn) => {
      btn.addEventListener('click', () => document.getElementById(btn.dataset.openModal)?.showModal());
    });
    document.querySelectorAll('[data-close-modal]').forEach((btn) => {
      btn.addEventListener('click', () => document.getElementById(btn.dataset.closeModal)?.close());
    });

    const syncEditComponentClassVisibility = () => {
      document.querySelectorAll('.inventory-edit-category').forEach((categoryField) => {
        const targetId = categoryField.dataset.target;
        const classWrapperEdit = document.getElementById(targetId);
        const classSelectEdit = classWrapperEdit?.querySelector('select[name="component_class"]');
        if (!classWrapperEdit || !classSelectEdit) return;

        const isPiece = (categoryField.value || '') === 'Peça';
        classWrapperEdit.style.display = isPiece ? '' : 'none';
        classSelectEdit.required = isPiece;
        if (!isPiece) classSelectEdit.value = '';
      });
    };

    document.querySelectorAll('.inventory-edit-category').forEach((el) => {
      el.addEventListener('change', syncEditComponentClassVisibility);
    });
    syncEditComponentClassVisibility();

  })();
</script>
{% endblock %}

<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ document_title }}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='print.css') }}" media="print" />
</head>
<body>
  <main class="container print-receipt thermal-receipt">
    <section class="card">
      <header class="receipt-header">
        <img class="receipt-logo" src="{{ url_for('static', filename='logo-lojaweb.svg') }}" alt="Logotipo LojaWeb" />
        <section class="receipt-header-grid">
          <article class="receipt-block">
            <h4>LojaWeb Tecnologia</h4>
            <p><strong>CNPJ:</strong> 00.000.000/0001-00</p>
            <p><strong>Endereço:</strong> Rua Exemplo, 123 - Centro</p>
            <p><strong>Contato:</strong> {{ store_contact }}</p>
          </article>
          <article class="receipt-block">
            <h4>Dados do Documento</h4>
            <p><strong>Data/Hora:</strong> {{ record_date.strftime('%d/%m/%Y %H:%M') }}</p>
            <p><strong>Documento:</strong> {{ record_code }}</p>
            <p><strong>Cliente/Referência:</strong> {{ client_name }}</p>
          </article>
        </section>
      </header>

      <section class="receipt-section-heading">
        <h3>Itens do documento</h3>
        <p class="receipt-legend">Legenda: <strong>Origem</strong> identifica o tipo de lançamento e <strong>SKU</strong> identifica o código do item no estoque.</p>
      </section>
      <table class="receipt-items-table">
        <thead>
          <tr><th>Descrição do item</th><th>Origem do item / SKU</th><th>Quantidade</th><th>Valor unitário</th><th>Subtotal</th></tr>
        </thead>
        <tbody>
          {% for row in items %}
          <tr>
            <td>{{ row.item }}</td>
            <td>{% if row.source_label is defined %}{{ row.source_label }}{% if row.sku %} · SKU: {{ row.sku }}{% endif %}{% else %}-{% endif %}</td>
            <td>{{ row.quantity }}</td>
            <td>R$ {{ '%.2f'|format(row.unit_price if row.unit_price is defined else 0) }}</td>
            <td>R$ {{ '%.2f'|format(row.total) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <section class="receipt-summary-grid">
        <article class="receipt-summary-card">
          <span>Subtotal bruto</span>
          <strong>R$ {{ '%.2f'|format(gross_total if gross_total is defined else subtotal) }}</strong>
        </article>
        <article class="receipt-summary-card">
          <span>Desconto aplicado</span>
          <strong>R$ {{ '%.2f'|format(discount_amount or 0) }}</strong>
        </article>
      </section>

      {% if record_code.startswith('MON-') %}
      <div class="receipt-total-box">
        <span>Total da montagem</span>
        <strong>R$ {{ '%.2f'|format(total) }}</strong>
      </div>
      {% else %}
      <div class="receipt-total-box">
        <span>Valor Líquido</span>
        <strong>R$ {{ '%.2f'|format(total) }}</strong>
      </div>
      {% endif %}
      <section class="receipt-info-grid">
        {% if payment_method_label is defined %}
        <article class="receipt-info-pill">
          <span>Forma de pagamento</span>
          <strong>{{ payment_method_label }}</strong>
        </article>
        {% endif %}

        {% if payment_status_label is defined %}
        <article class="receipt-info-pill">
          <span>Status do pagamento</span>
          <strong>{{ payment_status_label }}</strong>
        </article>
        {% endif %}
      </section>

      {% if payment_status_label is defined and payment_status_label == 'Pendente' %}
      <section class="pix-qrcode-block">
        <h3>Pagamento via Pix</h3>
        <p>Escaneie o QR Code para realizar o pagamento imediato.</p>
        <img
          src="https://quickchart.io/qr?size=180&text=PIX%20{{ record_code }}%20-%20R%24%20{{ '%.2f'|format(total) }}"
          alt="QR Code Pix para pagamento do documento {{ record_code }}"
          width="120"
          height="120"
        />
      </section>
      {% endif %}

      {% if payment_lines is defined and payment_lines %}
      <h3>Detalhes do Pagamento</h3>
      {% for payment in payment_lines %}
      <section class="payment-line">
        <p><strong>Método:</strong> {{ payment.method_label }} · <strong>Status:</strong> {{ payment.status_label }}</p>
        <p><strong>Valor:</strong> R$ {{ '%.2f'|format(payment.amount) }} · <strong>Pago:</strong> R$ {{ '%.2f'|format(payment.amount_paid) }} · <strong>Saldo:</strong> R$ {{ '%.2f'|format(payment.balance) }}</p>
        {% if payment.installments %}
        <table class="receipt-installments-table">
          <thead>
            <tr><th>Parcela</th><th>Vencimento</th><th>Valor</th><th>Pago</th><th>Status</th></tr>
          </thead>
          <tbody>
            {% for installment in payment.installments %}
            <tr>
              <td>{{ installment.number }}ª</td>
              <td>{{ installment.due_date.strftime('%d/%m/%Y') if installment.due_date else '-' }}</td>
              <td>R$ {{ '%.2f'|format(installment.amount) }}</td>
              <td>R$ {{ '%.2f'|format(installment.amount_paid) }}</td>
              <td>{{ installment.status_label }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% endif %}
      </section>
      {% endfor %}
      {% endif %}


      {% if service_receipt_lines is defined and service_receipt_lines %}
      <h3>Serviços realizados na venda</h3>
      {% for service in service_receipt_lines %}
      <section class="payment-line">
        <p><strong>Serviço:</strong> {{ service.service_name }}</p>
        <p><strong>Equipamento:</strong> {{ service.equipment }}</p>
        <p><strong>Valor:</strong> R$ {{ '%.2f'|format(service.total_price) }} · <strong>Custo:</strong> R$ {{ '%.2f'|format(service.cost) }}</p>
        <p><strong>Observações:</strong> {{ service.notes }}</p>
      </section>
      {% endfor %}
      {% endif %}

      {% if assembly_inline %}
      <section class="assembly-label-print">
        <h3>Recibo de montagem incorporado</h3>
        <p><strong>Montagem:</strong> {{ assembly_inline.nome_referencia or (assembly_inline.computador.name if assembly_inline.computador else 'Computador') }}</p>
        <p><strong>ID montagem:</strong> #{{ assembly_inline.id }}</p>
        <p><strong>Preço base:</strong> R$ {{ '%.2f'|format(assembly_inline.preco_original or 0) }}</p>
        <p><strong>Checklist:</strong> BIOS {{ 'Sim' if assembly_inline.bios_updated else 'Não' }}, Stress {{ 'Sim' if assembly_inline.stress_test_done else 'Não' }}, SO {{ 'Sim' if assembly_inline.os_installed else 'Não' }}</p>
        <p><strong>Adicionais:</strong> BIOS R$ {{ '%.2f'|format(assembly_inline.bios_service_cost or 0) }}, Stress R$ {{ '%.2f'|format(assembly_inline.stress_test_cost or 0) }}, SO R$ {{ '%.2f'|format(assembly_inline.os_install_cost or 0) }}</p>
        {% if assembly_receipt_items is defined and assembly_receipt_items %}
        <table class="receipt-items-table">
          <thead>
            <tr><th>Peça/Serviço</th><th>Origem</th><th>Qtd</th><th>Unitário</th><th>Subtotal</th></tr>
          </thead>
          <tbody>
            {% for part in assembly_receipt_items %}
            <tr>
              <td>{{ part.item }}</td>
              <td>{{ part.source_label }}</td>
              <td>{{ part.quantity }}</td>
              <td>R$ {{ '%.2f'|format(part.unit_price) }}</td>
              <td>R$ {{ '%.2f'|format(part.total) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% endif %}
      </section>
      {% endif %}
      <section class="receipt-notes-block">
        <p><strong>Observações:</strong> {{ notes }}</p>
        <p><strong>Técnico responsável:</strong> {{ performed_by_name }}</p>
      </section>

      {% if record_code.startswith('MON-') or record_code.startswith('OS-') %}
      <section class="signature-grid">
        <article class="signature-box">
          <p>Assinatura do Técnico</p>
        </article>
        <article class="signature-box">
          <p>Assinatura do Cliente</p>
        </article>
      </section>
      {% endif %}

      <footer class="receipt-legal-footer">
        <p>
          Garantia legal de 90 dias para serviços executados e peças com defeito de fabricação.
          Trocas sujeitas à avaliação técnica e apresentação deste documento.
        </p>
      </footer>

      {% if is_assembly_label is defined and is_assembly_label %}
      <section class="assembly-label-print">
        <h3>Etiqueta de Identificação</h3>
        <p><strong>Montagem:</strong> {{ assembly_name }}</p>
        <p><strong>ID:</strong> {{ assembly_id }}</p>
        <img src="{{ assembly_qr_url }}" alt="QR Code da montagem {{ assembly_id }}" width="120" height="120" />
      </section>
      {% endif %}
    </section>
  </main>
</body>
</html>

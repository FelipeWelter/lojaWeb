<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ document_title }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='print.css') }}" media="print" />
</head>
<body>
  <main class="container print-receipt thermal-receipt">
    <section class="card">
      <header>
        <h2>üñ•Ô∏è LojaWeb</h2>
        <p><strong>Data/Hora:</strong> {{ record_date.strftime('%d/%m/%Y %H:%M') }}</p>
        <p><strong>Documento:</strong> {{ record_code }}</p>
        <p><strong>Cliente/Refer√™ncia:</strong> {{ client_name }}</p>
      </header>

      <h3>Itens</h3>
      <table class="receipt-items-table">
        <thead>
          <tr><th>Produto</th><th>Origem/SKU</th><th>Qtd</th><th>Unit√°rio</th><th>Subtotal</th></tr>
        </thead>
        <tbody>
          {% for row in items %}
          <tr>
            <td>{{ row.item }}</td>
            <td>{% if row.source_label is defined %}{{ row.source_label }}{% if row.sku %} ¬∑ SKU: {{ row.sku }}{% endif %}{% else %}-{% endif %}</td>
            <td>{{ row.quantity }}</td>
            <td>R$ {{ '%.2f'|format(row.unit_price if row.unit_price is defined else 0) }}</td>
            <td>R$ {{ '%.2f'|format(row.total) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      {% if record_code.startswith('MON-') %}
      <p><strong>Total da montagem:</strong> R$ {{ '%.2f'|format(total) }}</p>
      {% else %}
      <p><strong>Valor Bruto:</strong> R$ {{ '%.2f'|format(gross_total if gross_total is defined else subtotal) }}</p>
      <p><strong>Desconto:</strong> R$ {{ '%.2f'|format(discount_amount or 0) }}</p>
      <p><strong>Valor L√≠quido:</strong> R$ {{ '%.2f'|format(total) }}</p>
      {% endif %}
      {% if payment_method_label is defined %}
      <p><strong>Forma de pagamento:</strong> {{ payment_method_label }}</p>
      {% endif %}

      {% if payment_status_label is defined %}
      <p><strong>Status do pagamento:</strong> {{ payment_status_label }}</p>
      {% endif %}

      {% if payment_lines is defined and payment_lines %}
      <h3>Detalhes do Pagamento</h3>
      {% for payment in payment_lines %}
      <section class="payment-line">
        <p><strong>M√©todo:</strong> {{ payment.method_label }} ¬∑ <strong>Status:</strong> {{ payment.status_label }}</p>
        <p><strong>Valor:</strong> R$ {{ '%.2f'|format(payment.amount) }} ¬∑ <strong>Pago:</strong> R$ {{ '%.2f'|format(payment.amount_paid) }} ¬∑ <strong>Saldo:</strong> R$ {{ '%.2f'|format(payment.balance) }}</p>
        {% if payment.installments %}
        <table class="receipt-installments-table">
          <thead>
            <tr><th>Parcela</th><th>Vencimento</th><th>Valor</th><th>Pago</th><th>Status</th></tr>
          </thead>
          <tbody>
            {% for installment in payment.installments %}
            <tr>
              <td>{{ installment.number }}¬™</td>
              <td>{{ installment.due_date.strftime('%d/%m/%Y') if installment.due_date else '-' }}</td>
              <td>R$ {{ '%.2f'|format(installment.amount) }}</td>
              <td>R$ {{ '%.2f'|format(installment.amount_paid) }}</td>
              <td>{{ installment.status_label }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% endif %}
      </section>
      {% endfor %}
      {% endif %}


      {% if service_receipt_lines is defined and service_receipt_lines %}
      <h3>Servi√ßos realizados na venda</h3>
      {% for service in service_receipt_lines %}
      <section class="payment-line">
        <p><strong>Servi√ßo:</strong> {{ service.service_name }}</p>
        <p><strong>Equipamento:</strong> {{ service.equipment }}</p>
        <p><strong>Valor:</strong> R$ {{ '%.2f'|format(service.total_price) }} ¬∑ <strong>Custo:</strong> R$ {{ '%.2f'|format(service.cost) }}</p>
        <p><strong>Observa√ß√µes:</strong> {{ service.notes }}</p>
      </section>
      {% endfor %}
      {% endif %}

      {% if assembly_inline %}
      <section class="assembly-label-print">
        <h3>Recibo de montagem incorporado</h3>
        <p><strong>Montagem:</strong> {{ assembly_inline.nome_referencia or (assembly_inline.computador.name if assembly_inline.computador else 'Computador') }}</p>
        <p><strong>ID montagem:</strong> #{{ assembly_inline.id }}</p>
        <p><strong>Pre√ßo base:</strong> R$ {{ '%.2f'|format(assembly_inline.preco_original or 0) }}</p>
        <p><strong>Total pe√ßas + adicionais:</strong> R$ {{ '%.2f'|format(assembly_inline.custo_total or 0) }}</p>
        <p><strong>Checklist:</strong> BIOS {{ 'Sim' if assembly_inline.bios_updated else 'N√£o' }}, Stress {{ 'Sim' if assembly_inline.stress_test_done else 'N√£o' }}, SO {{ 'Sim' if assembly_inline.os_installed else 'N√£o' }}</p>
        <p><strong>Adicionais:</strong> BIOS R$ {{ '%.2f'|format(assembly_inline.bios_service_cost or 0) }}, Stress R$ {{ '%.2f'|format(assembly_inline.stress_test_cost or 0) }}, SO R$ {{ '%.2f'|format(assembly_inline.os_install_cost or 0) }}</p>
        {% if assembly_receipt_items is defined and assembly_receipt_items %}
        <table class="receipt-items-table">
          <thead>
            <tr><th>Pe√ßa/Servi√ßo</th><th>Origem</th><th>Qtd</th><th>Unit√°rio</th><th>Subtotal</th></tr>
          </thead>
          <tbody>
            {% for part in assembly_receipt_items %}
            <tr>
              <td>{{ part.item }}</td>
              <td>{{ part.source_label }}</td>
              <td>{{ part.quantity }}</td>
              <td>R$ {{ '%.2f'|format(part.unit_price) }}</td>
              <td>R$ {{ '%.2f'|format(part.total) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% endif %}
      </section>
      {% endif %}
      <p><strong>Observa√ß√µes:</strong> {{ notes }}</p>
      <p><strong>T√©cnico respons√°vel:</strong> {{ performed_by_name }}</p>

      {% if is_assembly_label is defined and is_assembly_label %}
      <section class="assembly-label-print">
        <h3>Etiqueta de Identifica√ß√£o</h3>
        <p><strong>Montagem:</strong> {{ assembly_name }}</p>
        <p><strong>ID:</strong> {{ assembly_id }}</p>
        <img src="{{ assembly_qr_url }}" alt="QR Code da montagem {{ assembly_id }}" width="120" height="120" />
      </section>
      {% endif %}
    </section>
  </main>
</body>
</html>

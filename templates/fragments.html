{% macro sidebar(endpoint) %}
<aside class="app-sidebar">
  <a href="{{ url_for('dashboard') }}" class="sidebar-brand" aria-label="LojaWeb">
    <img src="{{ url_for('static', filename='logo-lojaweb.svg') }}" alt="LojaWeb" class="sidebar-logo" />
  </a>
  <nav>
    <a href="{{ url_for('dashboard') }}" class="{% if endpoint == 'dashboard' %}active{% endif %}">Dashboard</a>
    <a href="{{ url_for('produtos') }}" class="{% if endpoint == 'produtos' %}active{% endif %}">Produtos</a>
    <a href="{{ url_for('gestao_inventario') }}" class="{% if endpoint == 'gestao_inventario' %}active{% endif %}">Estoque</a>
    <a href="{{ url_for('servicos') }}" class="{% if endpoint == 'servicos' %}active{% endif %}">Serviços</a>
    <a href="{{ url_for('clientes') }}" class="{% if endpoint in ['clientes','editar_cliente','historico_cliente'] %}active{% endif %}">Clientes</a>
    <a href="{{ url_for('vendas') }}" class="{% if endpoint == 'vendas' %}active{% endif %}">Vendas</a>
    <a href="{{ url_for('logs_auditoria') }}" class="{% if endpoint == 'logs_auditoria' %}active{% endif %}">Logs</a>
    <a href="{{ url_for('usuarios') }}" class="nav-admin {% if endpoint == 'usuarios' %}active{% endif %}">Usuários</a>
    <a href="{{ url_for('logout') }}" class="nav-admin">Sair</a>
  </nav>
</aside>
{% endmacro %}

{% macro navbar(user_name) %}
<header class="app-navbar">
  <div class="navbar-brand">
    <img src="{{ url_for('static', filename='logo-lojaweb.svg') }}" alt="LojaWeb" class="navbar-logo" />
    <div>
      <h1>Painel de Gestão</h1>
      <small>Fluxo unificado para estoque e cadastro</small>
    </div>
  </div>
  <strong>{{ user_name or 'Operador' }}</strong>
</header>
{% endmacro %}

{% macro toast_messages(messages) %}
<div class="toast-stack" aria-live="polite" aria-atomic="true">
  {% for category, message in messages %}
  <div class="toast {{ category }}" data-autohide="true">{{ message }}</div>
  {% endfor %}
</div>
{% endmacro %}

{% macro scripts() %}
<script>
  (function () {
    const toasts = document.querySelectorAll('.toast');
    toasts.forEach((toast) => {
      window.setTimeout(() => toast.classList.add('is-hidden'), 3500);
    });

    const overlay = document.getElementById('print-loading-overlay');
    const showOverlay = () => overlay?.classList.remove('hidden');
    const hideOverlay = () => overlay?.classList.add('hidden');


    const decimalMath = {
      toCents(value) {
        if (typeof value === 'number' && Number.isFinite(value)) {
          return Math.round(value * 100);
        }

        const raw = String(value ?? '0').trim().replace(/\s/g, '');
        let normalized = raw;

        if (raw.includes(',') && raw.includes('.')) {
          normalized = raw.lastIndexOf(',') > raw.lastIndexOf('.')
            ? raw.replace(/\./g, '').replace(',', '.')
            : raw.replace(/,/g, '');
        } else if (raw.includes(',')) {
          normalized = raw.replace(/\./g, '').replace(',', '.');
        } else {
          normalized = raw.replace(/,/g, '');
        }

        const parsed = Number.parseFloat(normalized);
        return Number.isFinite(parsed) ? Math.round(parsed * 100) : 0;
      },
      fromCents(cents) {
        return (Number(cents || 0) / 100);
      },
      formatBRLFromCents(cents) {
        return this.fromCents(cents).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      },
    };
    window.decimalMath = decimalMath;

    const moneyInputs = document.querySelectorAll('input[data-money="true"]');

    const formatDigitsToMoney = (digits) => {
      const onlyDigits = String(digits || '').replace(/\D/g, '');
      const normalized = onlyDigits || '0';
      const cents = Number.parseInt(normalized, 10);
      return (cents / 100).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    moneyInputs.forEach((input) => {
      input.setAttribute('inputmode', 'numeric');
      input.autocomplete = 'off';
      input.value = formatDigitsToMoney(input.value);

      input.addEventListener('input', () => {
        input.value = formatDigitsToMoney(input.value);
      });

      const closestForm = input.closest('form');
      closestForm?.addEventListener('submit', () => {
        input.value = input.value.replace(/\./g, '').replace(',', '.');
      });
    });

    document.addEventListener('click', (event) => {
      const trigger = event.target.closest('.js-print-trigger');
      if (!trigger) return;

      const url = trigger.dataset.printUrl || trigger.getAttribute('href');
      if (!url) return;

      event.preventDefault();
      showOverlay();
      window.open(url, '_blank');
      window.setTimeout(hideOverlay, 1200);
    });
  })();
</script>
{% endmacro %}

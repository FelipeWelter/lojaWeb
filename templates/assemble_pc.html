{% extends 'base.html' %}
{% block content %}
<section class="card montaje-card">
  <h2>Montagem de Computadores</h2>
  <p class="montage-subtitle">Monte uma configura√ß√£o profissional em poucos cliques.</p>
  <form method="post" class="grid form-grid" id="form-montagem" enctype="multipart/form-data">
    <div class="pc-layout full-width">
      <section class="pc-builder-area">
        <div class="pc-header full-width">
          <label>
            Nome do computador (novo ou existente)
            <input name="computer_name" placeholder="Ex: GAMER" required />
          </label>
          <label>
            Pre√ßo base (opcional para existente)
            <input name="computer_original_price" type="number" min="0" step="0.01" placeholder="0,00" />
          </label>
          <div class="file-upload-field">
            <span class="field-label">Fotos do computador (opcional)</span>
            <input id="photo-files" name="photo_files" type="file" accept="image/*" multiple class="hidden-file-input" />
            <label for="photo-files" class="upload-dropzone" id="upload-trigger">
              <span class="upload-icon" aria-hidden="true">üì∑</span>
              <span>Clique para enviar a foto do PC</span>
            </label>
            <small id="upload-feedback">Nenhum arquivo selecionado.</small>
          </div>
        </div>

        <div class="components-scroll-area full-width">
          <div class="slots-top full-width">
      {% for slot_key, slot_label, allow_multiple in component_slots if not allow_multiple %}
      <div class="slot-box">
        <div class="slot-heading">
          <h3>{{ slot_label }}</h3>
          <span class="slot-icon" aria-hidden="true">üß©</span>
        </div>
        <div class="field-grid single-item-grid">
          <label>
            Item
            <input name="slot_{{ slot_key }}_entry" list="datalist-{{ slot_key }}" class="piece-entry" data-slot="{{ slot_key }}" placeholder="Selecione do estoque ou digite manualmente" />
            <input type="hidden" name="slot_{{ slot_key }}_stock_id" class="stock-id-input" />
            <datalist id="datalist-{{ slot_key }}">
              {% for part in parts_by_class[slot_key] if part.stock > 0 %}
              <option value="{{ part.name }}" data-id="{{ part.id }}" data-cost="{{ part.price }}" data-label="{{ part.name }} (R$ {{ '%.2f'|format(part.price) }}, estoque: {{ part.stock }})"></option>
              {% endfor %}
            </datalist>
          </label>
          <label>
            Custo (R$)
            <input name="slot_{{ slot_key }}_cost" type="number" min="0" step="0.01" placeholder="0,00" />
          </label>
        </div>
      </div>
      {% endfor %}
          </div>

          <div class="slots-bottom full-width">
      {% for slot_key, slot_label, allow_multiple in component_slots if allow_multiple %}
      <div class="slot-box slot-multiple">
        <div class="slot-heading">
          <h3>{{ slot_label }}</h3>
          <span class="slot-icon" aria-hidden="true">‚öôÔ∏è</span>
        </div>
        <div class="multi-list" data-slot="{{ slot_key }}">
          <div class="multi-row">
            <div class="field-stack multi-item-field">
              <label>Item</label>
              <input name="{{ slot_key }}_entries[]" list="datalist-{{ slot_key }}" class="piece-entry" data-slot="{{ slot_key }}" placeholder="Selecione ou escreva" />
              <input type="hidden" name="{{ slot_key }}_stock_ids[]" class="stock-id-input" />
            </div>

            <div class="field-stack multi-cost-field">
              <label>Custo (R$)</label>
              <input name="{{ slot_key }}_custom_costs[]" type="number" min="0" step="0.01" placeholder="0,00" />
            </div>

            <div class="field-stack multi-qty-field">
              <label>Quantidade</label>
              <div class="qty-control" title="Quantidade">
                <button type="button" class="qty-btn qty-decrease" aria-label="Diminuir">‚àí</button>
                <input type="number" name="{{ slot_key }}_qtys[]" min="1" value="1" />
                <button type="button" class="qty-btn qty-increase" aria-label="Aumentar">+</button>
              </div>
            </div>

            <button type="button" class="row-remove" title="Remover linha" aria-label="Remover linha">‚úï</button>
          </div>
        </div>
        <button type="button" class="add-item" data-slot="{{ slot_key }}">Ôºã Adicionar {{ slot_label }}</button>
      </div>
      {% endfor %}
          </div>
        </div>

        <div class="assembly-summary notes-panel full-width">
          <label>
            Observa√ß√µes t√©cnicas
            <textarea name="technical_notes" rows="4" placeholder="Ex: curva de fan ajustada, XMP ativado..."></textarea>
          </label>
          <div class="class-menu technical-checklist">
            <label><input type="checkbox" name="bios_updated" /> BIOS atualizada</label>
            <label><input type="checkbox" name="stress_test_done" /> Stress test realizado</label>
            <label><input type="checkbox" name="os_installed" /> Sistema operacional instalado</label>
            <label><input type="checkbox" name="create_stock_item" checked /> Criar item automaticamente em "Computador" no estoque</label>
          </div>
        </div>
      </section>

      <aside class="assembly-summary summary-highlight summary-sidebar">
        <div>
          <p class="summary-title">Resumo do Or√ßamento</p>
          <p><strong>Custo Total:</strong> <span id="total-custo">R$ 0,00</span></p>
          <p><strong>Pre√ßo Sugerido (+20%):</strong> <span id="preco-sugerido">R$ 0,00</span></p>
        </div>
        <button type="submit" class="summary-submit">Finalizar montagem</button>
        <p class="summary-hint">Use o modo <strong>P</strong> para pe√ßas manuais e informe um custo num√©rico para atualizar o lucro em tempo real.</p>
      </aside>
    </div>

    <div class="full-width summary-sticky-mobile">
      <div class="assembly-summary summary-highlight">
        <div>
          <p class="summary-title">Resumo do Or√ßamento</p>
          <p><strong>Custo Total:</strong> <span id="total-custo-mobile">R$ 0,00</span></p>
          <p><strong>Pre√ßo Sugerido (+20%):</strong> <span id="preco-sugerido-mobile">R$ 0,00</span></p>
        </div>
        <button type="submit" class="summary-submit">Finalizar montagem</button>
      </div>
    </div>
  </form>
</section>

<section class="card">
  <h2>Hist√≥rico de montagens</h2>
  <div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>Lote</th>
        <th>Refer√™ncia</th>
        <th>Computador</th>
        <th>Pre√ßo original</th>
        <th>Pre√ßo sugerido</th>
        <th>Custo pe√ßas</th>
        <th>Pe√ßas utilizadas</th>
        <th>Checklist t√©cnico</th>
        <th>Status</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody>
      {% for montagem in latest_assemblies %}
      <tr>
        <td>#{{ montagem.id }}</td>
        <td>{{ montagem.nome_referencia }}</td>
        <td>{{ montagem.computador.name if montagem.computador else "Computador removido" }}</td>
        <td>R$ {{ '%.2f'|format(montagem.preco_original) }}</td>
        <td>R$ {{ '%.2f'|format(montagem.preco_sugerido) }}</td>
        <td>R$ {{ '%.2f'|format(montagem.custo_total) }}</td>
        <td>
          {% for item in montagem.composicao %}
            <span class="assembly-part">{{ item.peca.name if item.peca else "Pe√ßa removida" }} x{{ item.quantidade_utilizada }}</span>{% if not loop.last or montagem.custom_parts %}, {% endif %}
          {% endfor %}
          {% for custom in montagem.custom_parts %}
            <span class="assembly-part">{{ custom.part_name }} x{{ custom.quantity }} (custom)</span>{% if not loop.last %}, {% endif %}
          {% endfor %}
        </td>
        <td>
          {% if montagem.technical_notes %}<div>{{ montagem.technical_notes }}</div>{% endif %}
          <small>
            BIOS: {{ 'Sim' if montagem.bios_updated else 'N√£o' }} |
            Stress: {{ 'Sim' if montagem.stress_test_done else 'N√£o' }} |
            SO: {{ 'Sim' if montagem.os_installed else 'N√£o' }}
          </small>
        </td>
        <td>
          {% if montagem.canceled %}
            <span class="badge danger">Cancelada</span>
          {% else %}
            <span class="badge success">Ativa</span>
          {% endif %}
        </td>
        <td>
          <div class="action-group">
            <button type="button" class="btn-secondary js-print-trigger" data-print-url="{{ url_for('imprimir', tipo='montagem', record_id=montagem.id) }}">Imprimir</button>
            <form method="post" action="{{ url_for('excluir_montagem', assembly_id=montagem.id) }}" onsubmit="return confirm('Deseja excluir esta montagem? Esta a√ß√£o n√£o pode ser desfeita.');">
              <button type="submit" class="btn-danger">Excluir montagem</button>
            </form>
          </div>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="10">Nenhuma montagem registrada.</td></tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
</section>

<script>
  const form = document.getElementById('form-montagem');
  const custoEl = document.getElementById('total-custo');
  const precoEl = document.getElementById('preco-sugerido');
  const custoMobileEl = document.getElementById('total-custo-mobile');
  const precoMobileEl = document.getElementById('preco-sugerido-mobile');

  function formatBRL(value) {
    return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  function syncPieceEntry(input) {
    if (!input) return;
    const row = input.closest('.multi-row, .slot-box');
    const hiddenId = row?.querySelector('.stock-id-input');
    const costInput = row?.querySelector('input[name$="_cost"], input[name$="_custom_costs[]"]');
    const listId = input.getAttribute('list');
    const list = listId ? document.getElementById(listId) : null;
    const match = list ? Array.from(list.options).find((option) => option.value === input.value) : null;

    if (match && hiddenId) {
      hiddenId.value = match.dataset.id || '';
      if (costInput) {
        costInput.value = Number(match.dataset.cost || 0).toFixed(2);
      }
      return;
    }

    if (hiddenId) hiddenId.value = '';
  }

  function atualizarTotais() {
    let total = 0;

    form.querySelectorAll('.multi-row').forEach((row) => {
      const stockId = row.querySelector('input[name$="_stock_ids[]"]')?.value;
      const entryInput = row.querySelector('input[name$="_entries[]"]');
      const qtyInput = row.querySelector('input[name$="_qtys[]"]');
      const customCostInput = row.querySelector('input[name$="_custom_costs[]"]');
      const qty = Number(qtyInput?.value || 0);
      const isStock = Boolean(stockId);

      if (isStock && qty > 0) {
        total += toNumber(customCostInput.value) * qty;
      } else if (entryInput && entryInput.value.trim() && qty > 0) {
        total += toNumber(customCostInput.value) * qty;
      }
    });

    form.querySelectorAll('.slots-top .slot-box').forEach((box) => {
      const entryInput = box.querySelector('input[name^="slot_"][name$="_entry"]');
      const stockId = box.querySelector('input[name^="slot_"][name$="_stock_id"]')?.value;
      const cost = box.querySelector('input[name^="slot_"][name$="_cost"]');

      if (!entryInput || !entryInput.value.trim()) return;
      if (stockId || entryInput.value.trim()) {
        total += toNumber(cost?.value || 0);
      }
    });

    custoEl.textContent = formatBRL(total);
    precoEl.textContent = formatBRL(total * 1.2);
    if (custoMobileEl && precoMobileEl) {
      custoMobileEl.textContent = formatBRL(total);
      precoMobileEl.textContent = formatBRL(total * 1.2);
    }
  }

  function toNumber(value) {
    if (typeof value === 'number') return value;
    return Number(String(value || '0').replace(',', '.')) || 0;
  }

  document.querySelectorAll('.add-item').forEach((btn) => {
    btn.addEventListener('click', () => {
      const slot = btn.dataset.slot;
      const list = document.querySelector(`.multi-list[data-slot="${slot}"]`);
      const firstRow = list.querySelector('.multi-row');
      const clone = firstRow.cloneNode(true);
      clone.querySelector('input[name$="_entries[]"]').value = '';
      clone.querySelector('input[name$="_stock_ids[]"]').value = '';
      clone.querySelector('input[name$="_custom_costs[]"]').value = '';
      clone.querySelector('input[name$="_qtys[]"]').value = 1;
      list.appendChild(clone);
      atualizarTotais();
    });
  });

  form.addEventListener('click', (event) => {
    const target = event.target;

    if (target.classList.contains('qty-decrease') || target.classList.contains('qty-increase')) {
      const input = target.parentElement.querySelector('input[type="number"]');
      const current = Number(input.value || 1);
      const delta = target.classList.contains('qty-increase') ? 1 : -1;
      input.value = Math.max(1, current + delta);
      atualizarTotais();
    }

    if (target.classList.contains('row-remove')) {
      const list = target.closest('.multi-list');
      const rows = list.querySelectorAll('.multi-row');
      if (rows.length > 1) {
        target.closest('.multi-row').remove();
      } else {
        const row = rows[0];
        row.querySelector('input[name$="_entries[]"]').value = '';
        row.querySelector('input[name$="_stock_ids[]"]').value = '';
        row.querySelector('input[name$="_custom_costs[]"]').value = '';
        row.querySelector('input[name$="_qtys[]"]').value = 1;
      }
      atualizarTotais();
    }
  });

  form.addEventListener('change', (event) => {
    if (event.target.classList.contains('piece-entry')) {
      syncPieceEntry(event.target);
    }
    if (event.target.id === 'photo-files') {
      const feedback = document.getElementById('upload-feedback');
      const trigger = document.getElementById('upload-trigger');
      const total = event.target.files?.length || 0;
      feedback.textContent = total ? `${total} arquivo(s) selecionado(s).` : 'Nenhum arquivo selecionado.';
      trigger.classList.toggle('has-file', total > 0);
    }
    atualizarTotais();
  });
  form.addEventListener('input', (event) => {
    if (event.target.classList.contains('piece-entry')) {
      syncPieceEntry(event.target);
    }
    atualizarTotais();
  });

  form.querySelectorAll('.piece-entry').forEach(syncPieceEntry);
  atualizarTotais();
</script>
{% endblock %}

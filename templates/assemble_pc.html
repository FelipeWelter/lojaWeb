{% extends 'base.html' %}
{% block content %}
<section class="card montaje-card">
  <h2>Montagem de Computadores</h2>
  <p class="montage-subtitle">Monte uma configura√ß√£o profissional em poucos cliques.</p>
  <form method="post" class="grid form-grid" id="form-montagem" enctype="multipart/form-data">
    <div class="pc-header full-width">
      <label>
        Nome do computador (novo ou existente)
        <input name="computer_name" placeholder="Ex: GAMER" required />
      </label>
      <label>
        Pre√ßo base (opcional para existente)
        <input name="computer_original_price" type="number" min="0" step="0.01" value="0" />
      </label>
      <label>
        Fotos do computador (opcional)
        <input name="photo_files" type="file" accept="image/*" multiple />
      </label>
    </div>

    <div class="slots-top full-width">
      {% for slot_key, slot_label, allow_multiple in component_slots if not allow_multiple %}
      <div class="slot-box">
        <div class="slot-heading">
          <h3>{{ slot_label }}</h3>
          <span class="slot-icon" aria-hidden="true">üß©</span>
        </div>
        <div class="piece-mode" role="group" aria-label="Modo de pe√ßa">
          <label><input type="radio" name="mode_{{ slot_key }}" value="stock" checked /> Estoque</label>
          <label><input type="radio" name="mode_{{ slot_key }}" value="custom" /> Personalizado</label>
        </div>
        <div class="stock-fields">
          <label>
            Pe√ßa
            <select name="slot_{{ slot_key }}" class="piece-select">
              <option value="">Sem sele√ß√£o (cliente j√° possui)</option>
              {% for part in parts_by_class[slot_key] %}
              <option value="{{ part.id }}" data-cost="{{ part.price }}" {% if part.stock <= 0 %}disabled{% endif %}>
                {{ part.name }} (R$ {{ '%.2f'|format(part.price) }}, estoque: {{ part.stock }})
              </option>
              {% endfor %}
            </select>
          </label>
        </div>
        <div class="custom-fields hidden">
          <label>
            Nome personalizado
            <input name="custom_{{ slot_key }}_name" placeholder="Ex: {{ slot_label }} do cliente" />
          </label>
          <label>
            Custo (R$)
            <input name="custom_{{ slot_key }}_cost" type="number" min="0" step="0.01" value="0" />
          </label>
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="slots-bottom full-width">
      {% for slot_key, slot_label, allow_multiple in component_slots if allow_multiple %}
      <div class="slot-box slot-multiple">
        <div class="slot-heading">
          <h3>{{ slot_label }}</h3>
          <span class="slot-icon" aria-hidden="true">‚öôÔ∏è</span>
        </div>
        <div class="multi-list" data-slot="{{ slot_key }}">
          <div class="multi-header">
            <span>Modo</span>
            <span>Item</span>
            <span>Custo (R$)</span>
            <span>Quantidade</span>
            <span></span>
          </div>

          <div class="multi-row">
            <div class="piece-mode compact" role="group" aria-label="Modo do item">
              <label><input type="radio" name="{{ slot_key }}_mode_0" value="stock" checked />E</label>
              <label><input type="radio" name="{{ slot_key }}_mode_0" value="custom" />P</label>
            </div>

            <div class="multi-item multi-stock-fields">
              <select name="{{ slot_key }}_ids[]" class="piece-select">
                <option value="">Sem sele√ß√£o</option>
                {% for part in parts_by_class[slot_key] %}
                <option value="{{ part.id }}" data-cost="{{ part.price }}" {% if part.stock <= 0 %}disabled{% endif %}>
                  {{ part.name }} (R$ {{ '%.2f'|format(part.price) }}, estoque: {{ part.stock }})
                </option>
                {% endfor %}
              </select>
              <input name="{{ slot_key }}_custom_names[]" class="hidden" placeholder="Pe√ßa personalizada" />
            </div>

            <input name="{{ slot_key }}_custom_costs[]" type="number" min="0" step="0.01" value="0" placeholder="0,00" />

            <div class="qty-control" title="Quantidade">
              <button type="button" class="qty-btn qty-decrease" aria-label="Diminuir">‚àí</button>
              <input type="number" name="{{ slot_key }}_qtys[]" min="1" value="1" />
              <button type="button" class="qty-btn qty-increase" aria-label="Aumentar">+</button>
            </div>

            <button type="button" class="row-remove" title="Remover linha" aria-label="Remover linha">‚úï</button>
          </div>
        </div>
        <button type="button" class="add-item" data-slot="{{ slot_key }}">Ôºã Adicionar {{ slot_label }}</button>
      </div>
      {% endfor %}
    </div>

    <div class="assembly-summary summary-highlight full-width">
      <div>
        <p class="summary-title">Resumo do Or√ßamento</p>
        <p><strong>Custo Total:</strong> <span id="total-custo">R$ 0,00</span></p>
        <p><strong>Pre√ßo Sugerido (+20%):</strong> <span id="preco-sugerido">R$ 0,00</span></p>
      </div>
      <button type="submit" class="summary-submit">Finalizar montagem</button>
    </div>

    <div class="assembly-summary full-width">
      <label>
        Observa√ß√µes t√©cnicas
        <textarea name="technical_notes" rows="3" placeholder="Ex: curva de fan ajustada, XMP ativado..."></textarea>
      </label>
      <div class="class-menu">
        <label><input type="checkbox" name="bios_updated" /> BIOS atualizada</label>
        <label><input type="checkbox" name="stress_test_done" /> Stress test realizado</label>
        <label><input type="checkbox" name="os_installed" /> Sistema operacional instalado</label>
        <label><input type="checkbox" name="create_stock_item" checked /> Criar item automaticamente em "Computador" no estoque</label>
      </div>
    </div>
  </form>
</section>

<section class="card">
  <h2>Hist√≥rico de montagens</h2>
  <table>
    <thead>
      <tr>
        <th>Lote</th>
        <th>Refer√™ncia</th>
        <th>Computador</th>
        <th>Pre√ßo original</th>
        <th>Pre√ßo sugerido</th>
        <th>Custo pe√ßas</th>
        <th>Pe√ßas utilizadas</th>
        <th>Checklist t√©cnico</th>
        <th>Status</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody>
      {% for montagem in latest_assemblies %}
      <tr>
        <td>#{{ montagem.id }}</td>
        <td>{{ montagem.nome_referencia }}</td>
        <td>{{ montagem.computador.name }}</td>
        <td>R$ {{ '%.2f'|format(montagem.preco_original) }}</td>
        <td>R$ {{ '%.2f'|format(montagem.preco_sugerido) }}</td>
        <td>R$ {{ '%.2f'|format(montagem.custo_total) }}</td>
        <td>
          {% for item in montagem.composicao %}
            <span class="assembly-part">{{ item.peca.name }} x{{ item.quantidade_utilizada }}</span>{% if not loop.last or montagem.custom_parts %}, {% endif %}
          {% endfor %}
          {% for custom in montagem.custom_parts %}
            <span class="assembly-part">{{ custom.part_name }} x{{ custom.quantity }} (custom)</span>{% if not loop.last %}, {% endif %}
          {% endfor %}
        </td>
        <td>
          {% if montagem.technical_notes %}<div>{{ montagem.technical_notes }}</div>{% endif %}
          <small>
            BIOS: {{ 'Sim' if montagem.bios_updated else 'N√£o' }} |
            Stress: {{ 'Sim' if montagem.stress_test_done else 'N√£o' }} |
            SO: {{ 'Sim' if montagem.os_installed else 'N√£o' }}
          </small>
        </td>
        <td>
          {% if montagem.canceled %}
            <span class="badge danger">Cancelada</span>
          {% else %}
            <span class="badge success">Ativa</span>
          {% endif %}
        </td>
        <td>
          {% if not montagem.canceled %}
            <button type="button" class="btn-secondary open-edit-modal" data-modal-id="assembly-modal-{{ montagem.id }}">Editar</button>
            <form method="post" action="{{ url_for('cancelar_montagem', assembly_id=montagem.id) }}" onsubmit="return confirm('Deseja cancelar esta montagem e estornar as pe√ßas no estoque?');">
              <button type="submit" class="btn-danger">Cancelar</button>
            </form>
          {% else %}
            <form method="post" action="{{ url_for('excluir_montagem', assembly_id=montagem.id) }}" onsubmit="return confirm('Deseja excluir esta montagem cancelada do hist√≥rico?');">
              <button type="submit" class="btn-danger">Excluir</button>
            </form>
          {% endif %}
        </td>
      </tr>

      {% if not montagem.canceled %}
      {% set edit_data = assembly_edit_data.get(montagem.id, {}) %}
      <dialog id="assembly-modal-{{ montagem.id }}" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3>Editar montagem #{{ montagem.id }}</h3>
            <button type="button" class="modal-close" data-close-modal="assembly-modal-{{ montagem.id }}">‚úï</button>
          </div>
          <form method="post" action="{{ url_for('editar_montagem', assembly_id=montagem.id) }}" class="grid form-grid edit-assembly-form" data-edit-form="{{ montagem.id }}">
            <div class="pc-header full-width">
              <label>
                Nome de refer√™ncia
                <input name="nome_referencia" value="{{ montagem.nome_referencia }}" required />
              </label>
              <label>
                Pre√ßo base
                <input name="preco_original" type="number" min="0" step="0.01" value="{{ montagem.preco_original }}" required />
              </label>
            </div>

            <div class="slots-top full-width">
              {% for slot_key, slot_label, allow_multiple in component_slots if not allow_multiple %}
              <div class="slot-box">
                <h3>{{ slot_label }}</h3>
                <label>
                  Sele√ß√£o
                  <select name="edit_slot_{{ slot_key }}" class="piece-select">
                    <option value="">Sem sele√ß√£o</option>
                    {% for part in parts_by_class[slot_key] %}
                    <option value="{{ part.id }}" data-cost="{{ part.price }}" {% if (edit_data.single_selected.get(slot_key) == part.id) %}selected{% endif %}>{{ part.name }} (R$ {{ '%.2f'|format(part.price) }}, estoque: {{ part.stock }})</option>
                    {% endfor %}
                  </select>
                </label>
                <label>
                  Ou pe√ßa personalizada
                  <input name="edit_custom_{{ slot_key }}_name" value="{{ edit_data.single_custom.get(slot_key, {}).get('name', '') }}" />
                </label>
                <label>
                  Custo (R$)
                  <input name="edit_custom_{{ slot_key }}_cost" type="number" min="0" step="0.01" value="{{ edit_data.single_custom.get(slot_key, {}).get('cost', '0') }}" />
                </label>
              </div>
              {% endfor %}
            </div>

            <div class="slots-bottom full-width">
              {% for slot_key, slot_label, allow_multiple in component_slots if allow_multiple %}
              <div class="slot-box slot-multiple">
                <h3>{{ slot_label }}</h3>
                <div class="multi-list" data-slot="edit_{{ slot_key }}">
                  <div class="multi-header"><span>Item</span><span>Qtd</span><span></span></div>
                  {% for row in edit_data.multi_rows.get(slot_key, [{'piece_id':'','qty':1,'custom_name':'','custom_cost':'0'}]) %}
                  <div class="multi-row">
                    <select name="edit_{{ slot_key }}_ids[]" class="piece-select">
                      <option value="">Sem sele√ß√£o</option>
                      {% for part in parts_by_class[slot_key] %}
                      <option value="{{ part.id }}" data-cost="{{ part.price }}" {% if row.piece_id == part.id %}selected{% endif %}>{{ part.name }} (R$ {{ '%.2f'|format(part.price) }}, estoque: {{ part.stock }})</option>
                      {% endfor %}
                    </select>
                    <input name="edit_{{ slot_key }}_custom_names[]" placeholder="Ou personalizada" value="{{ row.custom_name }}" />
                    <input name="edit_{{ slot_key }}_custom_costs[]" type="number" min="0" step="0.01" value="{{ row.custom_cost }}" />
                    <div class="qty-control" title="Quantidade">
                      <button type="button" class="qty-btn qty-decrease" aria-label="Diminuir">‚àí</button>
                      <input type="number" name="edit_{{ slot_key }}_qtys[]" min="1" value="{{ row.qty }}" />
                      <button type="button" class="qty-btn qty-increase" aria-label="Aumentar">+</button>
                    </div>
                    <button type="button" class="row-remove" title="Remover linha" aria-label="Remover linha">‚úï</button>
                  </div>
                  {% endfor %}
                </div>
                <button type="button" class="add-item edit-add-item" data-slot="edit_{{ slot_key }}">Ôºã Adicionar {{ slot_label }}</button>
              </div>
              {% endfor %}
            </div>

            <div class="assembly-summary full-width">
              <label>
                Observa√ß√µes t√©cnicas
                <textarea name="technical_notes" rows="3">{{ montagem.technical_notes or '' }}</textarea>
              </label>
              <div class="class-menu">
                <label><input type="checkbox" name="bios_updated" {% if montagem.bios_updated %}checked{% endif %}/> BIOS atualizada</label>
                <label><input type="checkbox" name="stress_test_done" {% if montagem.stress_test_done %}checked{% endif %}/> Stress test realizado</label>
                <label><input type="checkbox" name="os_installed" {% if montagem.os_installed %}checked{% endif %}/> Sistema operacional instalado</label>
              </div>
            </div>

            <button type="submit">Salvar altera√ß√µes</button>
          </form>
        </div>
      </dialog>
      {% endif %}
      {% else %}
      <tr><td colspan="10">Nenhuma montagem registrada.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<script>
  const form = document.getElementById('form-montagem');
  const custoEl = document.getElementById('total-custo');
  const precoEl = document.getElementById('preco-sugerido');

  function formatBRL(value) {
    return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  function atualizarTotais() {
    let total = 0;
    form.querySelectorAll('.multi-row').forEach((row) => {
      const select = row.querySelector('select');
      const qtyInput = row.querySelector('input[name$="_qtys[]"]');
      const customCostInput = row.querySelector('input[name$="_custom_costs[]"]');
      const customNameInput = row.querySelector('input[name$="_custom_names[]"]');
      const modeInput = row.querySelector('input[type="radio"][value="custom"]');
      const isCustom = modeInput ? modeInput.checked : false;
      const option = select.options[select.selectedIndex];
      const qty = Number(qtyInput?.value || 0);

      if (!isCustom && option && option.value && qty > 0) {
        total += Number(option.dataset.cost || 0) * qty;
      } else if (isCustom && customNameInput && customNameInput.value.trim() && qty > 0) {
        total += Number(customCostInput.value || 0) * qty;
      }
    });

    form.querySelectorAll('.slots-top .slot-box').forEach((box) => {
      const select = box.querySelector('select[name^="slot_"]');
      const customRadio = box.querySelector('input[type="radio"][value="custom"]');
      const isCustom = customRadio ? customRadio.checked : false;
      const option = select.options[select.selectedIndex];

      if (!isCustom && option && option.value) {
        total += Number(option.dataset.cost || 0);
      } else {
        const slot = select.name.replace('slot_', '');
        const name = form.querySelector(`input[name="custom_${slot}_name"]`);
        const cost = form.querySelector(`input[name="custom_${slot}_cost"]`);
        if (name && name.value.trim()) {
          total += Number(cost.value || 0);
        }
      }
    });

    const sugerido = total * 1.2;
    custoEl.textContent = formatBRL(total);
    precoEl.textContent = formatBRL(sugerido);
  }


  function atualizarVisibilidadeModos() {
    form.querySelectorAll('.slots-top .slot-box').forEach((box) => {
      const customRadio = box.querySelector('input[type="radio"][value="custom"]');
      const stockFields = box.querySelector('.stock-fields');
      const customFields = box.querySelector('.custom-fields');
      const isCustom = customRadio?.checked;
      stockFields.classList.toggle('hidden', isCustom);
      customFields.classList.toggle('hidden', !isCustom);
    });

    form.querySelectorAll('.multi-row').forEach((row) => {
      const customRadio = row.querySelector('input[type="radio"][value="custom"]');
      const select = row.querySelector('select');
      const customInput = row.querySelector('input[name$="_custom_names[]"]');
      const isCustom = customRadio?.checked;
      select.classList.toggle('hidden', isCustom);
      customInput.classList.toggle('hidden', !isCustom);
    });
  }

  function renumerarModosMultiplos() {
    document.querySelectorAll('.multi-list').forEach((list) => {
      const slot = list.dataset.slot;
      list.querySelectorAll('.multi-row').forEach((row, index) => {
        row.querySelectorAll('.piece-mode.compact input[type="radio"]').forEach((radio) => {
          radio.name = `${slot}_mode_${index}`;
        });
      });
    });
  }

  document.querySelectorAll('.add-item').forEach((btn) => {
    btn.addEventListener('click', () => {
      const slot = btn.dataset.slot;
      const list = document.querySelector(`.multi-list[data-slot="${slot}"]`);
      const firstRow = list.querySelector('.multi-row');
      const clone = firstRow.cloneNode(true);
      clone.querySelector('select').selectedIndex = 0;
      const customName = clone.querySelector('input[name$="_custom_names[]"]');
      const customCost = clone.querySelector('input[name$="_custom_costs[]"]');
      const qtyInput = clone.querySelector('input[name$="_qtys[]"]');
      if (customName) customName.value = '';
      if (customCost) customCost.value = 0;
      if (qtyInput) qtyInput.value = 1;
      const stockRadio = clone.querySelector('input[type="radio"][value="stock"]');
      if (stockRadio) stockRadio.checked = true;
      list.appendChild(clone);
      renumerarModosMultiplos();
      atualizarVisibilidadeModos();
      atualizarTotais();
    });
  });

  document.querySelectorAll('.open-edit-modal').forEach((btn) => {
    btn.addEventListener('click', () => {
      const modal = document.getElementById(btn.dataset.modalId);
      if (modal) modal.showModal();
    });
  });

  document.querySelectorAll('[data-close-modal]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const modal = document.getElementById(btn.dataset.closeModal);
      if (modal) modal.close();
    });
  });

  document.querySelectorAll('dialog.modal').forEach((modal) => {
    modal.addEventListener('click', (event) => {
      const rect = modal.getBoundingClientRect();
      const clickedBackdrop =
        event.clientX < rect.left ||
        event.clientX > rect.right ||
        event.clientY < rect.top ||
        event.clientY > rect.bottom;
      if (clickedBackdrop) modal.close();
    });
  });

  form.addEventListener('click', (event) => {
    const target = event.target;

    if (target.classList.contains('qty-decrease') || target.classList.contains('qty-increase')) {
      const input = target.parentElement.querySelector('input[type="number"]');
      const current = Number(input.value || 1);
      const delta = target.classList.contains('qty-increase') ? 1 : -1;
      input.value = Math.max(1, current + delta);
      atualizarTotais();
    }

    if (target.classList.contains('row-remove')) {
      const list = target.closest('.multi-list');
      const rows = list.querySelectorAll('.multi-row');
      if (rows.length > 1) {
        target.closest('.multi-row').remove();
        renumerarModosMultiplos();
      } else {
        const row = rows[0];
        row.querySelector('select').selectedIndex = 0;
        const customName = row.querySelector('input[name$="_custom_names[]"]');
        const customCost = row.querySelector('input[name$="_custom_costs[]"]');
        const qtyInput = row.querySelector('input[name$="_qtys[]"]');
        if (customName) customName.value = '';
        if (customCost) customCost.value = 0;
        if (qtyInput) qtyInput.value = 1;
      }
      atualizarTotais();
    }
  });


  document.querySelectorAll('.edit-add-item').forEach((btn) => {
    btn.addEventListener('click', () => {
      const list = btn.parentElement.querySelector(`.multi-list[data-slot="${btn.dataset.slot}"]`);
      const firstRow = list.querySelector('.multi-row');
      const clone = firstRow.cloneNode(true);
      clone.querySelector('select').selectedIndex = 0;
      const customName = clone.querySelector('input[name$="_custom_names[]"]');
      const customCost = clone.querySelector('input[name$="_custom_costs[]"]');
      const qtyInput = clone.querySelector('input[name$="_qtys[]"]');
      if (customName) customName.value = '';
      if (customCost) customCost.value = 0;
      if (qtyInput) qtyInput.value = 1;
      const stockRadio = clone.querySelector('input[type="radio"][value="stock"]');
      if (stockRadio) stockRadio.checked = true;
      list.appendChild(clone);
    });
  });

  document.querySelectorAll('.edit-assembly-form').forEach((editForm) => {
    editForm.addEventListener('click', (event) => {
      const target = event.target;
      if (target.classList.contains('qty-decrease') || target.classList.contains('qty-increase')) {
        const input = target.parentElement.querySelector('input[name$="_qtys[]"]');
        const current = Number(input.value || 1);
        const delta = target.classList.contains('qty-increase') ? 1 : -1;
        input.value = Math.max(1, current + delta);
      }
      if (target.classList.contains('row-remove')) {
        const list = target.closest('.multi-list');
        const rows = list.querySelectorAll('.multi-row');
        if (rows.length > 1) {
          target.closest('.multi-row').remove();
        }
      }
    });
  });

  form.addEventListener('change', () => {
    atualizarVisibilidadeModos();
    atualizarTotais();
  });
  form.addEventListener('input', atualizarTotais);
  renumerarModosMultiplos();
  atualizarVisibilidadeModos();
  atualizarTotais();
</script>
{% endblock %}

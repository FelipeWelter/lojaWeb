{% extends 'base.html' %}
{% block content %}
{% from 'components.html' import piece_slot %}
<section class="card montaje-card">
  <div class="action-group" style="margin-bottom:10px;">
    <a href="{{ url_for('produtos') }}" class="btn-loja btn-loja--secondary">‚¨Ö Voltar para Produtos</a>
  </div>
  <h2>Montagem de Computadores</h2>
  <p class="montage-subtitle">Monte uma configura√ß√£o profissional em poucos cliques.</p>
  <form method="post" class="grid form-grid" id="form-montagem" enctype="multipart/form-data">
    <div class="pc-layout full-width">
      <section class="pc-builder-area">
        <div class="pc-header full-width">
          <label>
            Nome do computador (novo ou existente)
            <input name="computer_name" placeholder="Ex: GAMER" required />
          </label>
          <label>
            Pre√ßo base (opcional para existente)
            <input name="computer_original_price" type="number" min="0" step="0.01" placeholder="0,00" />
          </label>
          <div class="file-upload-field">
            <span class="field-label">Fotos do computador (opcional)</span>
            <input id="photo-files" name="photo_files" type="file" accept="image/*" multiple class="hidden-file-input" />
            <label for="photo-files" class="upload-dropzone" id="upload-trigger">
              <span class="upload-icon" aria-hidden="true">üì∑</span>
              <span>Clique para enviar a foto do PC</span>
            </label>
            <small id="upload-feedback">Nenhum arquivo selecionado.</small>
          </div>
        </div>

        <div class="components-scroll-area full-width assembly-lines">
          <div class="assembly-row two-columns">
            {{ piece_slot('gabinete', 'Gabinete', parts_by_class) }}
            {{ piece_slot('fans', 'Fans', parts_by_class, 'üåÄ') }}
          </div>

          <div class="assembly-row two-columns">
            {{ piece_slot('placa_mae', 'Placa-m√£e', parts_by_class) }}
            {{ piece_slot('processador', 'Processador', parts_by_class) }}
          </div>

          <div class="assembly-row one-column">
            {{ piece_slot('fonte', 'Fonte', parts_by_class) }}
          </div>

          <div class="assembly-row one-column">
            {{ piece_slot('memoria_ram', 'Mem√≥ria RAM', parts_by_class, allow_multiple=True) }}
          </div>

          <div class="assembly-row one-column">
            {{ piece_slot('armazenamento', 'Armazenamento', parts_by_class, allow_multiple=True) }}
          </div>

          <div class="assembly-row one-column">
            <div class="slot-box optional-panel" data-slot="opcionais">
              <div class="slot-heading">
                <h3>Opcionais / Observa√ß√µes</h3>
                <span class="slot-icon" aria-hidden="true">üìù</span>
              </div>
              {{ piece_slot('placa_video', 'Placa de V√≠deo', parts_by_class, 'üéÆ') }}

              <div class="assembly-summary notes-panel full-width">
                <label>
                  Observa√ß√µes t√©cnicas
                  <textarea name="technical_notes" rows="4" placeholder="Ex: curva de fan ajustada, XMP ativado..."></textarea>
                </label>
                <div class="class-menu technical-checklist">
                  <label><input type="checkbox" name="bios_updated" /> BIOS atualizada</label>
                  <label><input type="checkbox" name="stress_test_done" /> Stress test realizado</label>
                  <label><input type="checkbox" name="os_installed" /> Sistema operacional instalado</label>
                  <label><input type="checkbox" name="create_stock_item" checked /> Criar item automaticamente em "Computador" no estoque</label>
                  <label><input type="checkbox" name="send_to_sales" /> Enviar montagem finalizada direto para o carrinho de vendas</label>
                </div>
              </div>

              <div class="assembly-summary summary-highlight summary-inline">
                <div>
                  <p class="summary-title">Resumo do Or√ßamento</p>
                  <p><strong>Custo Total:</strong> <span id="total-custo">R$ 0,00</span></p>
                  <p><strong>Pre√ßo Sugerido (+20%):</strong> <span id="preco-sugerido">R$ 0,00</span></p>
                </div>
                <button type="submit" class="summary-submit">Finalizar montagem</button>
                <p class="summary-hint">Use o modo <strong>P</strong> para pe√ßas manuais e informe um custo num√©rico para atualizar o lucro em tempo real.</p>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </form>
</section>

<section class="card">
  <h2>Hist√≥rico de montagens</h2>
  <div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>Lote</th>
        <th>Refer√™ncia</th>
        <th>Computador</th>
        <th>Pre√ßo original</th>
        <th>Pre√ßo sugerido</th>
        <th>Custo pe√ßas</th>
        <th>Pe√ßas utilizadas</th>
        <th>Checklist t√©cnico</th>
        <th>Status</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody>
      {% for montagem in latest_assemblies %}
      <tr>
        <td>#{{ montagem.id }}</td>
        <td>{{ montagem.nome_referencia }}</td>
        <td>{{ montagem.computador.name if montagem.computador else "Computador removido" }}</td>
        <td>R$ {{ '%.2f'|format(montagem.preco_original) }}</td>
        <td>R$ {{ '%.2f'|format(montagem.preco_sugerido) }}</td>
        <td>R$ {{ '%.2f'|format(montagem.custo_total) }}</td>
        <td>
          {% for item in montagem.composicao %}
            <span class="assembly-part">{{ item.peca.name if item.peca else "Pe√ßa removida" }} x{{ item.quantidade_utilizada }}</span>{% if not loop.last or montagem.custom_parts %}, {% endif %}
          {% endfor %}
          {% for custom in montagem.custom_parts %}
            <span class="assembly-part">{{ custom.part_name }} x{{ custom.quantity }} (custom)</span>{% if not loop.last %}, {% endif %}
          {% endfor %}
        </td>
        <td>
          {% if montagem.technical_notes %}<div>{{ montagem.technical_notes }}</div>{% endif %}
          <small>
            BIOS: {{ 'Sim' if montagem.bios_updated else 'N√£o' }} |
            Stress: {{ 'Sim' if montagem.stress_test_done else 'N√£o' }} |
            SO: {{ 'Sim' if montagem.os_installed else 'N√£o' }}
          </small>
        </td>
        <td>
          {% if montagem.canceled %}
            <span class="badge danger">Cancelada</span>
          {% else %}
            <span class="badge success">Ativa</span>
          {% endif %}
        </td>
        <td>
          <div class="action-group">
            {% if not montagem.canceled %}
            <button type="button" class="btn-loja btn-loja--secondary js-toggle-edit" data-target="assembly-edit-{{ montagem.id }}">Editar</button>
            {% endif %}
            <button type="button" class="btn-secondary js-print-trigger" data-print-url="{{ url_for('imprimir', tipo='montagem', record_id=montagem.id) }}">Imprimir</button>
            <form method="post" action="{{ url_for('excluir_montagem', assembly_id=montagem.id) }}" onsubmit="return confirm('Deseja excluir esta montagem? Esta a√ß√£o n√£o pode ser desfeita.');">
              <button type="submit" class="btn-danger">Excluir montagem</button>
            </form>
          </div>
        </td>
      </tr>
      {% if not montagem.canceled %}
      {% set edit_data = assembly_edit_data.get(montagem.id, {}) %}
      {% set edit_single = edit_data.get('single_slots', {}) %}
      {% set edit_multi = edit_data.get('multi_rows', {}) %}
      <tr id="assembly-edit-{{ montagem.id }}" class="assembly-edit-row" hidden>
        <td colspan="10">
          <form method="post" action="{{ url_for('editar_montagem', assembly_id=montagem.id) }}" class="grid form-grid js-assembly-form">
            <div class="pc-layout full-width">
              <section class="pc-builder-area">
                <div class="pc-header full-width">
                  <label>
                    Nome da refer√™ncia
                    <input name="nome_referencia" required value="{{ montagem.nome_referencia }}" />
                  </label>
                  <label>
                    Pre√ßo base
                    <input name="preco_original" type="number" min="0" step="0.01" value="{{ '%.2f'|format(montagem.preco_original) }}" required />
                  </label>
                </div>

                <div class="components-scroll-area full-width assembly-lines">
                  <div class="assembly-row two-columns">
                    {{ piece_slot('gabinete', 'Gabinete', parts_by_class, prefix='edit_', single_data=edit_single.get('gabinete'), datalist_suffix='edit-' ~ montagem.id ~ '-') }}
                    {{ piece_slot('fans', 'Fans', parts_by_class, 'üåÄ', prefix='edit_', single_data=edit_single.get('fans'), datalist_suffix='edit-' ~ montagem.id ~ '-') }}
                  </div>

                  <div class="assembly-row two-columns">
                    {{ piece_slot('placa_mae', 'Placa-m√£e', parts_by_class, prefix='edit_', single_data=edit_single.get('placa_mae'), datalist_suffix='edit-' ~ montagem.id ~ '-') }}
                    {{ piece_slot('processador', 'Processador', parts_by_class, prefix='edit_', single_data=edit_single.get('processador'), datalist_suffix='edit-' ~ montagem.id ~ '-') }}
                  </div>

                  <div class="assembly-row one-column">
                    {{ piece_slot('fonte', 'Fonte', parts_by_class, prefix='edit_', single_data=edit_single.get('fonte'), datalist_suffix='edit-' ~ montagem.id ~ '-') }}
                  </div>

                  <div class="assembly-row one-column">
                    {{ piece_slot('memoria_ram', 'Mem√≥ria RAM', parts_by_class, allow_multiple=True, prefix='edit_', multi_data=edit_multi.get('memoria_ram'), datalist_suffix='edit-' ~ montagem.id ~ '-') }}
                  </div>

                  <div class="assembly-row one-column">
                    {{ piece_slot('armazenamento', 'Armazenamento', parts_by_class, allow_multiple=True, prefix='edit_', multi_data=edit_multi.get('armazenamento'), datalist_suffix='edit-' ~ montagem.id ~ '-') }}
                  </div>

                  <div class="assembly-row one-column">
                    <div class="slot-box optional-panel" data-slot="opcionais">
                      <div class="slot-heading">
                        <h3>Opcionais / Observa√ß√µes</h3>
                        <span class="slot-icon" aria-hidden="true">üìù</span>
                      </div>
                      {{ piece_slot('placa_video', 'Placa de V√≠deo', parts_by_class, 'üéÆ', prefix='edit_', single_data=edit_single.get('placa_video'), datalist_suffix='edit-' ~ montagem.id ~ '-') }}

                      <div class="assembly-summary notes-panel full-width">
                        <label>
                          Observa√ß√µes t√©cnicas
                          <textarea name="technical_notes" rows="4" placeholder="Ex: curva de fan ajustada, XMP ativado...">{{ montagem.technical_notes or '' }}</textarea>
                        </label>
                        <div class="class-menu technical-checklist">
                          <label><input type="checkbox" name="bios_updated" {% if montagem.bios_updated %}checked{% endif %} /> BIOS atualizada</label>
                          <label><input type="checkbox" name="stress_test_done" {% if montagem.stress_test_done %}checked{% endif %} /> Stress test realizado</label>
                          <label><input type="checkbox" name="os_installed" {% if montagem.os_installed %}checked{% endif %} /> Sistema operacional instalado</label>
                        </div>
                      </div>

                      <div class="assembly-summary summary-highlight summary-inline">
                        <div>
                          <p class="summary-title">Resumo da Edi√ß√£o</p>
                          <p><strong>Custo Total:</strong> <span class="js-total-custo">R$ 0,00</span></p>
                          <p><strong>Pre√ßo Sugerido (+20%):</strong> <span class="js-preco-sugerido">R$ 0,00</span></p>
                        </div>
                        <button type="submit" class="summary-submit">Salvar edi√ß√£o</button>
                      </div>
                    </div>
                  </div>
                </div>
              </section>
            </div>
          </form>
        </td>
      </tr>
      {% endif %}
      {% else %}
      <tr><td colspan="10">Nenhuma montagem registrada.</td></tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
</section>

{% set modal_id='assembly-confirm-modal' %}
{% set modal_title='Enviar para o carrinho?' %}
{% set modal_message='Voc√™ poder√° finalizar a venda imediatamente ap√≥s montar o PC.' %}
{% include 'includes/modal.html' %}

<script>
  const createForm = document.getElementById('form-montagem');
  const custoEl = document.getElementById('total-custo');
  const precoEl = document.getElementById('preco-sugerido');
  const custoMobileEl = document.getElementById('total-custo-mobile');
  const precoMobileEl = document.getElementById('preco-sugerido-mobile');

  function formatBRL(value) {
    return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  function syncPieceEntry(input) {
    if (!input) return;
    const row = input.closest('.multi-row, .slot-box');
    const hiddenId = row?.querySelector('.stock-id-input');
    const costInput = row?.querySelector('input[name$="_cost"], input[name$="_custom_costs[]"]');
    const listId = input.getAttribute('list');
    const list = listId ? document.getElementById(listId) : null;
    const normalizedInput = String(input.value || '').trim().toLowerCase();
    const match = list
      ? Array.from(list.options).find((option) => {
          const optionValue = String(option.value || '').trim().toLowerCase();
          const optionLabel = String(option.getAttribute('label') || option.dataset.label || '').trim().toLowerCase();
          const optionLabelPrefix = optionLabel.split(' (r$')[0];
          return normalizedInput && (
            optionValue === normalizedInput
            || optionLabel === normalizedInput
            || optionLabelPrefix === normalizedInput
          );
        })
      : null;

    if (match && hiddenId) {
      hiddenId.value = match.dataset.id || '';
      if (costInput) {
        costInput.value = Number(match.dataset.cost || 0).toFixed(2);
      }
      return;
    }

    if (hiddenId) hiddenId.value = '';
  }

  function atualizarTotais(form) {
    if (!form) return;
    let total = 0;

    form.querySelectorAll('.multi-row').forEach((row) => {
      const stockId = row.querySelector('input[name$="_stock_ids[]"]')?.value;
      const entryInput = row.querySelector('input[name$="_entries[]"]');
      const qtyInput = row.querySelector('input[name$="_qtys[]"]');
      const customCostInput = row.querySelector('input[name$="_custom_costs[]"]');
      const qty = Number(qtyInput?.value || 0);
      const isStock = Boolean(stockId);

      if (isStock && qty > 0) {
        total += toNumber(customCostInput.value) * qty;
      } else if (entryInput && entryInput.value.trim() && qty > 0) {
        total += toNumber(customCostInput.value) * qty;
      }
    });

    form.querySelectorAll('.single-slot').forEach((box) => {
      const entryInput = box.querySelector('input[name^="slot_"][name$="_entry"]');
      const stockId = box.querySelector('input[name^="slot_"][name$="_stock_id"]')?.value;
      const cost = box.querySelector('input[name^="slot_"][name$="_cost"]');

      if (!entryInput || !entryInput.value.trim()) return;
      if (stockId || entryInput.value.trim()) {
        total += toNumber(cost?.value || 0);
      }
    });

    const localCustoEl = form === createForm ? custoEl : form.querySelector('.js-total-custo');
    const localPrecoEl = form === createForm ? precoEl : form.querySelector('.js-preco-sugerido');
    if (localCustoEl) localCustoEl.textContent = formatBRL(total);
    if (localPrecoEl) localPrecoEl.textContent = formatBRL(total * 1.2);
    if (form === createForm && custoMobileEl && precoMobileEl) {
      custoMobileEl.textContent = formatBRL(total);
      precoMobileEl.textContent = formatBRL(total * 1.2);
    }
  }

  function toNumber(value) {
    if (typeof value === 'number') return value;
    return Number(String(value || '0').replace(',', '.')) || 0;
  }

  document.querySelectorAll('.js-assembly-form').forEach((form) => {
    form.addEventListener('click', (event) => {
      const target = event.target;

      if (target.classList.contains('qty-decrease') || target.classList.contains('qty-increase')) {
        const input = target.parentElement.querySelector('input[type="number"]');
        const current = Number(input.value || 1);
        const delta = target.classList.contains('qty-increase') ? 1 : -1;
        input.value = Math.max(1, current + delta);
        atualizarTotais(form);
      }

      if (target.classList.contains('row-remove')) {
        const list = target.closest('.multi-list');
        const rows = list.querySelectorAll('.multi-row');
        if (rows.length > 1) {
          target.closest('.multi-row').remove();
        } else {
          const row = rows[0];
          row.querySelector('input[name$="_entries[]"]').value = '';
          row.querySelector('input[name$="_stock_ids[]"]').value = '';
          row.querySelector('input[name$="_custom_costs[]"]').value = '';
          row.querySelector('input[name$="_qtys[]"]').value = 1;
        }
        atualizarTotais(form);
      }
    });

    form.addEventListener('change', (event) => {
      if (event.target.classList.contains('piece-entry')) {
        syncPieceEntry(event.target);
      }
      if (event.target.id === 'photo-files') {
        const feedback = document.getElementById('upload-feedback');
        const trigger = document.getElementById('upload-trigger');
        const total = event.target.files?.length || 0;
        feedback.textContent = total ? `${total} arquivo(s) selecionado(s).` : 'Nenhum arquivo selecionado.';
        trigger.classList.toggle('has-file', total > 0);
      }
      atualizarTotais(form);
    });

    form.addEventListener('input', (event) => {
      if (event.target.classList.contains('piece-entry')) {
        syncPieceEntry(event.target);
      }
      atualizarTotais(form);
    });
  });

  document.querySelectorAll('.add-item').forEach((btn) => {
    btn.addEventListener('click', () => {
      const list = btn.closest('.slot-multiple')?.querySelector('.multi-list');
      if (!list) return;
      const parentForm = btn.closest('form');
      const firstRow = list.querySelector('.multi-row');
      const clone = firstRow.cloneNode(true);
      clone.querySelector('input[name$="_entries[]"]').value = '';
      clone.querySelector('input[name$="_stock_ids[]"]').value = '';
      clone.querySelector('input[name$="_custom_costs[]"]').value = '';
      clone.querySelector('input[name$="_qtys[]"]').value = 1;
      list.appendChild(clone);
      atualizarTotais(parentForm);
    });
  });

  document.querySelectorAll('.js-toggle-edit').forEach((button) => {
    button.addEventListener('click', () => {
      const targetId = button.dataset.target;
      const row = document.getElementById(targetId);
      if (!row) return;
      row.hidden = !row.hidden;
      button.textContent = row.hidden ? 'Editar' : 'Fechar edi√ß√£o';
      if (!row.hidden) {
        const editForm = row.querySelector('form');
        if (editForm) {
          editForm.querySelectorAll('.piece-entry').forEach(syncPieceEntry);
          atualizarTotais(editForm);
        }
      }
    });
  });

  document.querySelectorAll('.js-assembly-form').forEach((form) => {
    form.querySelectorAll('.piece-entry').forEach(syncPieceEntry);
    atualizarTotais(form);
  });
</script>
{% endblock %}

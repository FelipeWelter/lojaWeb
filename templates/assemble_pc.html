{% extends 'base.html' %}
{% block content %}
<section class="card montaje-card">
  <h2>Montagem de Computadores</h2>
  <form method="post" class="grid form-grid" id="form-montagem">
    <label class="full-width">
      Nome do computador (refer√™ncia no estoque)
      <input name="computer_name" placeholder="Ex: PC Gamer Ryzen 7" required />
    </label>

    {% for slot_key, slot_label, allow_multiple in component_slots %}
    <div class="slot-box {% if allow_multiple %}slot-multiple{% endif %}">
      <label>
        {{ slot_label }} (opcional)
        {% if not allow_multiple %}
        <select name="slot_{{ slot_key }}" class="piece-select">
          <option value="">Sem sele√ß√£o (cliente j√° possui)</option>
          {% for part in parts_by_class[slot_key] %}
          <option value="{{ part.id }}" data-cost="{{ part.price }}" {% if part.stock <= 0 %}disabled{% endif %}>
            #{{ part.id }} - {{ part.name }} (R$ {{ '%.2f'|format(part.price) }}, estoque: {{ part.stock }})
          </option>
          {% endfor %}
        </select>
        {% endif %}
      </label>

      {% if allow_multiple %}
      <div class="multi-list" data-slot="{{ slot_key }}">
        <div class="multi-row">
          <select name="{{ slot_key }}_ids[]" class="piece-select">
            <option value="">Sem sele√ß√£o</option>
            {% for part in parts_by_class[slot_key] %}
            <option value="{{ part.id }}" data-cost="{{ part.price }}" {% if part.stock <= 0 %}disabled{% endif %}>
              #{{ part.id }} - {{ part.name }} (R$ {{ '%.2f'|format(part.price) }}, estoque: {{ part.stock }})
            </option>
            {% endfor %}
          </select>
          <label class="qty-box" title="Quantidade">
            <span>üî¢</span>
            <input type="number" name="{{ slot_key }}_qtys[]" min="1" value="1" />
          </label>
        </div>
      </div>
      <button type="button" class="add-item" data-slot="{{ slot_key }}">Ôºã Adicionar {{ slot_label }}</button>
      {% endif %}
    </div>
    {% endfor %}

    <div class="assembly-summary">
      <p><strong>Custo total das pe√ßas:</strong> <span id="total-custo">R$ 0,00</span></p>
      <p><strong>Pre√ßo sugerido (+20%):</strong> <span id="preco-sugerido">R$ 0,00</span></p>
    </div>

    <button type="submit">Finalizar montagem</button>
  </form>
</section>

<section class="card">
  <h2>Hist√≥rico de montagens</h2>
  <table>
    <thead>
      <tr>
        <th>Lote</th>
        <th>Refer√™ncia</th>
        <th>Computador</th>
        <th>Custo total</th>
        <th>Pre√ßo sugerido</th>
        <th>Pe√ßas utilizadas (ID x qtd)</th>
      </tr>
    </thead>
    <tbody>
      {% for montagem in latest_assemblies %}
      <tr>
        <td>#{{ montagem.id }}</td>
        <td>{{ montagem.nome_referencia }}</td>
        <td>#{{ montagem.computador.id }} - {{ montagem.computador.name }}</td>
        <td>R$ {{ '%.2f'|format(montagem.custo_total) }}</td>
        <td>R$ {{ '%.2f'|format(montagem.preco_sugerido) }}</td>
        <td>
          {% for item in montagem.composicao %}
            [Pe√ßa #{{ item.peca.id }}: {{ item.peca.name }} x{{ item.quantidade_utilizada }}]{% if not loop.last %}, {% endif %}
          {% endfor %}
        </td>
      </tr>
      {% else %}
      <tr><td colspan="6">Nenhuma montagem registrada.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<script>
  const form = document.getElementById('form-montagem');
  const custoEl = document.getElementById('total-custo');
  const precoEl = document.getElementById('preco-sugerido');

  function formatBRL(value) {
    return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  function atualizarTotais() {
    let total = 0;
    form.querySelectorAll('.multi-row').forEach((row) => {
      const select = row.querySelector('select');
      const qtyInput = row.querySelector('input[type="number"]');
      const option = select.options[select.selectedIndex];
      const qty = Number(qtyInput.value || 0);
      if (option && option.value && qty > 0) {
        total += Number(option.dataset.cost || 0) * qty;
      }
    });

    form.querySelectorAll('.slot-box select[name^="slot_"]').forEach((select) => {
      const option = select.options[select.selectedIndex];
      if (option && option.value) {
        total += Number(option.dataset.cost || 0);
      }
    });

    const sugerido = total * 1.2;
    custoEl.textContent = formatBRL(total);
    precoEl.textContent = formatBRL(sugerido);
  }

  document.querySelectorAll('.add-item').forEach((btn) => {
    btn.addEventListener('click', () => {
      const slot = btn.dataset.slot;
      const list = document.querySelector(`.multi-list[data-slot="${slot}"]`);
      const firstRow = list.querySelector('.multi-row');
      const clone = firstRow.cloneNode(true);
      clone.querySelector('select').selectedIndex = 0;
      clone.querySelector('input').value = 1;
      list.appendChild(clone);
      atualizarTotais();
    });
  });

  form.addEventListener('change', atualizarTotais);
  form.addEventListener('input', atualizarTotais);
  atualizarTotais();
</script>
{% endblock %}

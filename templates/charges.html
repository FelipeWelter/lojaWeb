{% extends 'base.html' %}
{% block content %}
<section class="card">
  <h2>Nova cobrança (Mercado Pago)</h2>
  <form method="post" class="grid form-grid">
    <label>
      Venda (opcional)
      <select name="sale_id">
        <option value="">Sem venda</option>
        {% for s in sales %}<option value="{{ s.id }}">{{ s.sale_name }} - {{ s.client.name }} - R$ {{ '%.2f'|format(s.total) }}</option>{% endfor %}
      </select>
    </label>
    <label>
      Serviço (opcional)
      <select name="service_id">
        <option value="">Sem serviço</option>
        {% for srv in services %}<option value="{{ srv.id }}">#{{ srv.id }} - {{ srv.service_name }} - {{ srv.client_name }} - R$ {{ '%.2f'|format(srv.total_price) }}</option>{% endfor %}
      </select>
    </label>
    <input name="mercado_pago_reference" placeholder="ID/referência no Mercado Pago" required />
    <select name="payment_method" required>
      {% for value, label in payment_methods %}<option value="{{ value }}">{{ label }}</option>{% endfor %}
    </select>
    <select name="status">
      <option value="pendente">Pendente</option>
      <option value="confirmado">Confirmado</option>
      <option value="cancelado">Cancelado</option>
    </select>
    <button type="submit">Registrar cobrança</button>
  </form>
</section>
<section class="card">
  <h2>Cobranças</h2>
  <table>
    <thead><tr><th>Origem</th><th>Ref. Mercado Pago</th><th>Pagamento</th><th>Status</th><th>Confirmação</th><th>Ações</th></tr></thead>
    <tbody>
      {% for c in charges %}
      <tr>
        <td>{% if c.sale %}Venda: {{ c.sale.sale_name }} - {{ c.sale.client.name }}{% elif c.service %}Serviço: {{ c.service.service_name }} - {{ c.service.client_name }}{% else %}-{% endif %}</td>
        <td>{{ c.mercado_pago_reference }}</td>
        <td>{{ c.payment_method|capitalize }}</td>
        <td>{{ c.status }}</td>
        <td>{{ c.payment_confirmed_at.strftime('%d/%m/%Y %H:%M') if c.payment_confirmed_at else '-' }}</td>
        <td>
          <form method="post" action="{{ url_for('editar_cobranca', charge_id=c.id) }}" class="inline-form">
            <input name="mercado_pago_reference" value="{{ c.mercado_pago_reference }}" required />
            <select name="payment_method">
              {% for value, label in payment_methods %}
              <option value="{{ value }}" {% if c.payment_method == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
            <select name="status">
              <option value="pendente" {% if c.status == 'pendente' %}selected{% endif %}>Pendente</option>
              <option value="confirmado" {% if c.status == 'confirmado' %}selected{% endif %}>Confirmado</option>
              <option value="cancelado" {% if c.status == 'cancelado' %}selected{% endif %}>Cancelado</option>
            </select>
            <button type="submit">Salvar</button>
          </form>
        </td>
      </tr>
      {% else %}<tr><td colspan="6">Sem cobranças.</td></tr>{% endfor %}
    </tbody>
  </table>
</section>
{% endblock %}

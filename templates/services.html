{% extends 'base.html' %}
{% block content %}
<section class="card">
  <h2>Serviços</h2>
  <p class="montage-subtitle">Portfólio de serviços técnicos da LojaWeb.</p>
  <div class="cards service-cards">
    {% for service in services %}
    <article class="card service-card">
      <h3>{{ service.name }}</h3>
      <p>{{ service.description }}</p>
      <p class="service-price">R$ {{ '%.2f'|format(service.price) }}</p>
      <button type="button" class="quick-service-btn" data-service-name="{{ service.name }}" data-service-price="{{ service.price }}">Cadastrar serviço realizado</button>
    </article>
    {% endfor %}
  </div>
</section>

<section class="card">
  <h2>Cadastro de computador em manutenção</h2>
  <form method="post" class="grid form-grid">
    <input type="hidden" name="form_type" value="maintenance_ticket" />
    <input name="maintenance_client_name" placeholder="Cliente" required />
    <input name="maintenance_equipment" placeholder="Equipamento" required />
    <input name="maintenance_service_description" placeholder="Serviço em execução" required />
    <label>
      Data de entrada
      <input name="maintenance_entry_date" type="datetime-local" />
    </label>
    <label>
      <input name="maintenance_waiting_parts" type="checkbox" /> Aguardando peças
    </label>
    <button type="submit">Adicionar na manutenção</button>
  </form>
</section>

<section class="card">
  <h2>Controle de manutenção</h2>
  <table>
    <thead>
      <tr><th>Cliente</th><th>Equipamento</th><th>Serviço</th><th>Entrada</th><th>Saída</th><th>Status</th><th>Ação</th></tr>
    </thead>
    <tbody>
      {% for ticket in maintenance_tickets %}
      <tr>
        <td>{{ ticket.client_name }}</td>
        <td>{{ ticket.equipment }}</td>
        <td>{{ ticket.service_description }}</td>
        <td>{{ ticket.entry_date.strftime('%d/%m/%Y %H:%M') }}</td>
        <td>{{ ticket.exit_date.strftime('%d/%m/%Y %H:%M') if ticket.exit_date else '-' }}</td>
        <td>
          {% if ticket.status == 'concluido' %}
            <span class="badge success">Concluído</span>
          {% elif ticket.waiting_parts %}
            <span class="badge danger">Aguardando peças</span>
          {% else %}
            <span class="badge">Em andamento</span>
          {% endif %}
        </td>
        <td>
          <form method="post" action="{{ url_for('atualizar_manutencao', ticket_id=ticket.id) }}" class="inline-form">
            <select name="status">
              <option value="em_andamento" {% if ticket.status == 'em_andamento' %}selected{% endif %}>Em andamento</option>
              <option value="aguardando_pecas" {% if ticket.status == 'aguardando_pecas' %}selected{% endif %}>Aguardando peças</option>
              <option value="concluido" {% if ticket.status == 'concluido' %}selected{% endif %}>Concluído</option>
            </select>
            <label><input type="checkbox" name="waiting_parts" {% if ticket.waiting_parts %}checked{% endif %}/> Aguardando peças</label>
            <input type="datetime-local" name="exit_date" value="{{ ticket.exit_date.strftime('%Y-%m-%dT%H:%M') if ticket.exit_date else '' }}" />
            <button type="submit">Atualizar</button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="7">Nenhum equipamento em manutenção.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<section class="card">
  <h2>Cadastrar serviço realizado</h2>
  <form method="post" class="grid form-grid">
    <input type="hidden" name="form_type" value="service_record" />
    <input name="service_name" placeholder="Nome do serviço" required />
    <input name="client_name" placeholder="Cliente" required />
    <input name="equipment" placeholder="Equipamento" required />
    <input name="total_price" type="number" min="0" step="0.01" placeholder="Valor cobrado" required />
    <input name="cost" type="number" min="0" step="0.01" placeholder="Custo do serviço" required />
    <input name="notes" placeholder="Observações (opcional)" />
    <button type="submit">Salvar serviço realizado</button>
  </form>
</section>

<section class="card">
  <h2>Últimos serviços realizados</h2>
  <table>
    <thead>
      <tr><th>Data</th><th>Serviço</th><th>Cliente</th><th>Equipamento</th><th>Valor</th><th>Custo</th><th>Lucro</th><th>Ações</th></tr>
    </thead>
    <tbody>
      {% for service in recent_services %}
      <tr>
        <td>{{ service.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
        <td>{{ service.service_name }}</td>
        <td>{{ service.client_name }}</td>
        <td>{{ service.equipment }}</td>
        <td>R$ {{ '%.2f'|format(service.total_price) }}</td>
        <td>R$ {{ '%.2f'|format(service.cost) }}</td>
        <td>R$ {{ '%.2f'|format(service.total_price - service.cost) }}</td>
        <td><a class="btn-link" href="{{ url_for('imprimir_servico', service_id=service.id) }}">Imprimir</a></td>
      </tr>
      {% else %}
      <tr><td colspan="8">Nenhum serviço realizado cadastrado ainda.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<script>
  const serviceNameInput = document.querySelector('input[name="service_name"]');
  const servicePriceInput = document.querySelector('input[name="total_price"]');
  const serviceRecordForm = document.querySelector('form input[name="form_type"][value="service_record"]')?.closest('form');

  document.querySelectorAll('.quick-service-btn').forEach((button) => {
    button.addEventListener('click', () => {
      if (serviceNameInput) {
        serviceNameInput.value = button.dataset.serviceName || '';
      }
      if (servicePriceInput && !servicePriceInput.value) {
        servicePriceInput.value = button.dataset.servicePrice || '';
      }
      serviceRecordForm?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      serviceNameInput?.focus();
    });
  });
</script>
{% endblock %}

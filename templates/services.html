{% extends 'base.html' %}
{% block content %}
<section class="card services-shell">
  <h2>Abertura de Nova OS</h2>
  <p class="montage-subtitle">Preencha os dados iniciais para enviar o equipamento direto para a bancada.</p>
  <form method="post" class="grid form-grid services-form">
    <input type="hidden" name="form_type" value="maintenance_ticket" />

    <label class="floating-field">
      <span>Nome do cliente</span>
      <input name="maintenance_client_name" required />
    </label>
    <label class="floating-field">
      <span>Telefone</span>
      <input name="maintenance_client_phone" />
    </label>
    <label class="floating-field">
      <span>Equipamento</span>
      <input name="maintenance_equipment" required />
    </label>
    <label class="floating-field">
      <span>Servi√ßo solicitado</span>
      <input name="maintenance_service_description" required />
    </label>
    <label class="floating-field">
      <span>Status inicial</span>
      <select name="maintenance_status">
        {% for value, label in maintenance_status_options %}
        <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="floating-field">
      <span>Data de entrada</span>
      <input name="maintenance_entry_date" type="datetime-local" />
    </label>
    <label class="floating-field">
      <span>Pe√ßa do estoque (opcional)</span>
      <select name="maintenance_part_id">
        <option value="">Sem troca de pe√ßa</option>
        {% for product in products %}
        <option value="{{ product.id }}">{{ product.name }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="floating-field">
      <span>Qtd. pe√ßa</span>
      <input name="maintenance_part_qty" type="number" min="1" value="1" />
    </label>
    <label class="floating-field">
      <span>M√£o de obra (R$)</span>
      <input name="maintenance_labor_cost" type="number" min="0" step="0.01" value="0" />
    </label>

    <label class="floating-field full-width">
      <span>Relato do cliente</span>
      <textarea name="maintenance_customer_report" rows="2"></textarea>
    </label>
    <label class="floating-field full-width">
      <span>Diagn√≥stico t√©cnico</span>
      <textarea name="maintenance_technical_diagnosis" rows="2"></textarea>
    </label>
    <label class="floating-field full-width">
      <span>Observa√ß√µes da bancada</span>
      <textarea name="maintenance_observations" rows="2"></textarea>
    </label>

    <div class="checklist-block full-width">
      <p>Checklist de manuten√ß√£o</p>
      <div class="checklist-list">
        {% for item in maintenance_checklist %}
        <label><input type="checkbox" name="check_{{ loop.index0 }}" /> {{ item }}</label>
        {% endfor %}
      </div>
    </div>

    <button type="submit">Abrir OS</button>
  </form>
</section>

<section class="card services-shell">
  <h2>Manuten√ß√µes em Andamento</h2>
  <table>
    <thead>
      <tr><th>Cliente</th><th>Equipamento</th><th>Servi√ßo</th><th>Entrada</th><th>Status</th><th>A√ß√µes</th></tr>
    </thead>
    <tbody>
      {% for ticket in active_tickets %}
      <tr>
        <td>{{ ticket.client_name }}</td>
        <td>{{ ticket.equipment }}</td>
        <td>{{ ticket.service_description }}</td>
        <td>{{ ticket.entry_date.strftime('%d/%m/%Y %H:%M') }}</td>
        <td>
          {% if ticket.status == 'aguardando_pecas' %}
          <span class="badge warning">{{ maintenance_status_labels.get(ticket.status, ticket.status) }}</span>
          {% elif ticket.status == 'em_analise' %}
          <span class="badge info">{{ maintenance_status_labels.get(ticket.status, ticket.status) }}</span>
          {% elif ticket.status == 'cancelado' %}
          <span class="badge danger">{{ maintenance_status_labels.get(ticket.status, ticket.status) }}</span>
          {% else %}
          <span class="badge">{{ maintenance_status_labels.get(ticket.status, ticket.status) }}</span>
          {% endif %}
        </td>
        <td>
          <details class="service-actions-menu">
            <summary>‚ãØ</summary>
            <div class="service-actions-list">
              <form method="post" action="{{ url_for('atualizar_manutencao', ticket_id=ticket.id) }}" class="inline-form">
                <input type="hidden" name="action" value="editar" />
                <select name="status">
                  {% for value, label in maintenance_status_options %}
                  <option value="{{ value }}" {% if ticket.status == value %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
                <button type="submit" class="btn-secondary">‚öôÔ∏è Editar</button>
              </form>
              <button type="button" class="btn-secondary" onclick="window.open('{{ url_for('imprimir', tipo='manutencao', record_id=ticket.id) }}', '_blank')">üñ®Ô∏è Imprimir OS</button>
              <form method="post" action="{{ url_for('atualizar_manutencao', ticket_id=ticket.id) }}">
                <input type="hidden" name="action" value="finalizar" />
                <button type="submit">‚úÖ Finalizar</button>
              </form>
            </div>
          </details>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="6">Nenhum equipamento em manuten√ß√£o ativa.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<section class="card services-shell">
  <div class="history-head">
    <h2>Hist√≥rico de Servi√ßos Conclu√≠dos</h2>
    <input id="service-history-search" type="search" placeholder="Buscar cliente, equipamento ou servi√ßo..." />
  </div>
  <table>
    <thead>
      <tr><th>Data</th><th>Servi√ßo</th><th>Cliente</th><th>Equipamento</th><th>Valor final</th><th>A√ß√µes</th></tr>
    </thead>
    <tbody id="service-history-body">
      {% for service in recent_services %}
      <tr>
        <td>{{ service.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
        <td>{{ service.service_name }}</td>
        <td>{{ service.client_name }}</td>
        <td>{{ service.equipment }}</td>
        <td>R$ {{ '%.2f'|format(service.total_price) }}</td>
        <td><button type="button" class="btn-secondary" onclick="window.open('{{ url_for('imprimir', tipo='servico', record_id=service.id) }}', '_blank')">üñ®Ô∏è Imprimir</button></td>
      </tr>
      {% else %}
      <tr><td colspan="6">Nenhum servi√ßo conclu√≠do cadastrado.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<script>
  const historySearch = document.getElementById('service-history-search');
  const historyRows = Array.from(document.querySelectorAll('#service-history-body tr'));

  historySearch?.addEventListener('input', () => {
    const term = historySearch.value.toLowerCase().trim();
    historyRows.forEach((row) => {
      const show = row.textContent.toLowerCase().includes(term);
      row.style.display = show ? '' : 'none';
    });
  });
</script>
{% endblock %}

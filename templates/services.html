{% extends 'base.html' %}
{% block content %}
<section class="card services-shell">
  <h2>Abertura de Nova OS</h2>
  <p class="montage-subtitle">Preencha os dados iniciais para enviar o equipamento direto para a bancada.</p>
  <form method="post" class="grid form-grid services-form services-form-two-col">
    <input type="hidden" name="form_type" value="maintenance_ticket" />

    <label class="floating-field">
      <span>Nome do cliente</span>
      <input name="maintenance_client_name" placeholder="Opcional na abertura" />
    </label>
    <label class="floating-field">
      <span>Telefone</span>
      <input name="maintenance_client_phone" />
    </label>
    <label class="floating-field">
      <span>Equipamento</span>
      <input name="maintenance_equipment" placeholder="Opcional na abertura" />
    </label>
    <label class="floating-field">
      <span>Servi√ßo solicitado</span>
      <input name="maintenance_service_description" placeholder="Opcional na abertura" />
    </label>
    <label class="floating-field">
      <span>Status inicial</span>
      <select name="maintenance_status">
        {% for value, label in maintenance_status_options %}
        <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="floating-field">
      <span>Data de entrada</span>
      <input name="maintenance_entry_date" type="datetime-local" />
    </label>
    <div class="full-width">
      <span>Pe√ßas do estoque (opcional)</span>
      <div id="maintenance-parts-list" class="grid form-grid">
        <div class="maintenance-part-row">
          <label class="floating-field">
            <span>Pe√ßa do estoque</span>
            <select name="maintenance_part_id[]">
              <option value="">Sem troca de pe√ßa</option>
              {% for product in products %}
              <option value="{{ product.id }}">{{ product.name }}</option>
              {% endfor %}
            </select>
          </label>
          <label class="floating-field">
            <span>Qtd. pe√ßa</span>
            <input name="maintenance_part_qty[]" type="number" min="1" value="1" />
          </label>
          <button type="button" class="btn-secondary remove-part-row" style="align-self:end;" hidden>Remover</button>
        </div>
      </div>
      <button type="button" id="add-maintenance-part" class="btn-secondary" style="margin-top:8px;">+ Adicionar pe√ßa</button>
    </div>
    <label class="floating-field">
      <span>M√£o de obra (R$)</span>
      <input name="maintenance_labor_cost" type="number" min="0" step="0.01" placeholder="0,00" />
    </label>

    <label class="floating-field full-width">
      <span>Relato do cliente</span>
      <textarea name="maintenance_customer_report" rows="2"></textarea>
    </label>
    <label class="floating-field full-width">
      <span>Diagn√≥stico t√©cnico</span>
      <textarea name="maintenance_technical_diagnosis" rows="2"></textarea>
    </label>
    <label class="floating-field full-width">
      <span>Observa√ß√µes da bancada</span>
      <textarea name="maintenance_observations" rows="2"></textarea>
    </label>

    <div class="checklist-block full-width">
      <p>Checklist de manuten√ß√£o</p>
      <div class="checklist-list">
        {% for item in maintenance_checklist %}
        <label><input type="checkbox" name="check_{{ loop.index0 }}" /> {{ item }}</label>
        {% endfor %}
      </div>
    </div>

    <button type="submit">Abrir OS</button>
  </form>
</section>

<section class="card services-shell">
  <h2>Manuten√ß√µes em Andamento</h2>
  <table>
    <thead>
      <tr><th>Cliente</th><th>Equipamento</th><th>Servi√ßo</th><th>Entrada</th><th>Status</th><th>A√ß√µes</th></tr>
    </thead>
    <tbody>
      {% for ticket in active_tickets %}
      <tr>
        <td>{{ ticket.client_name }}</td>
        <td>{{ ticket.equipment }}</td>
        <td>{{ ticket.service_description }}</td>
        <td>{{ ticket.entry_date.strftime('%d/%m/%Y %H:%M') }}</td>
        <td>
          {% if ticket.status == 'aguardando_pecas' %}
          <span class="badge warning">{{ maintenance_status_labels.get(ticket.status, ticket.status) }}</span>
          {% elif ticket.status == 'em_analise' %}
          <span class="badge info">{{ maintenance_status_labels.get(ticket.status, ticket.status) }}</span>
          {% elif ticket.status == 'cancelado' %}
          <span class="badge danger">{{ maintenance_status_labels.get(ticket.status, ticket.status) }}</span>
          {% else %}
          <span class="badge">{{ maintenance_status_labels.get(ticket.status, ticket.status) }}</span>
          {% endif %}
        </td>
        <td>
          <details class="service-actions-menu">
            <summary>‚ãØ</summary>
            <div class="service-actions-list">
              <details>
                <summary>‚öôÔ∏è Editar OS completa</summary>
                <form method="post" action="{{ url_for('atualizar_manutencao', ticket_id=ticket.id) }}" class="inline-form service-edit-form" data-ticket-id="{{ ticket.id }}">
                  <input type="hidden" name="action" value="editar" />
                  <input name="maintenance_client_name" value="{{ ticket.client_name }}" placeholder="Nome do cliente" />
                  <input name="maintenance_client_phone" value="{{ ticket.client_phone or '' }}" placeholder="Telefone" />
                  <input name="maintenance_equipment" value="{{ ticket.equipment }}" placeholder="Equipamento" />
                  <input name="maintenance_service_description" value="{{ ticket.service_description }}" placeholder="Servi√ßo" />
                  <input name="maintenance_labor_cost" type="number" min="0" step="0.01" value="{{ '%.2f'|format(ticket.labor_cost or 0) }}" placeholder="M√£o de obra" />
                  <select name="status">
                    {% set edit_status = "em_analise" if ticket.status == "em_andamento" else ticket.status %}
                    {% for value, label in maintenance_status_options %}
                    <option value="{{ value }}" {% if edit_status == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                  <textarea name="maintenance_customer_report" rows="2" placeholder="Relato do cliente">{{ ticket.customer_report or '' }}</textarea>
                  <textarea name="maintenance_technical_diagnosis" rows="2" placeholder="Diagn√≥stico t√©cnico">{{ ticket.technical_diagnosis or '' }}</textarea>
                  <textarea name="maintenance_observations" rows="2" placeholder="Observa√ß√µes">{{ ticket.observations or '' }}</textarea>
                  <div class="checklist-block">
                    <p>Checklist de manuten√ß√£o</p>
                    <div class="checklist-list">
                      {% set done_labels = maintenance_checklist_map.get(ticket.id, []) %}
                      {% for item in maintenance_checklist %}
                      <label><input type="checkbox" name="check_{{ loop.index0 }}" {% if item in done_labels %}checked{% endif %}/> {{ item }}</label>
                      {% endfor %}
                    </div>
                  </div>
                  <div>
                    <small>Pe√ßas da OS</small>
                    {% set existing_parts = maintenance_parts_map.get(ticket.id, []) %}
                    <div class="grid form-grid edit-maintenance-parts-list">
                      {% if existing_parts %}
                        {% for part in existing_parts %}
                        <div class="maintenance-part-row">
                          <select name="maintenance_part_id[]">
                            <option value="">Sem troca de pe√ßa</option>
                            {% for product in products %}
                            <option value="{{ product.id }}" {% if part.get('product_id') == product.id %}selected{% endif %}>{{ product.name }}</option>
                            {% endfor %}
                          </select>
                          <input name="maintenance_part_qty[]" type="number" min="1" value="{{ part.get('quantity') or 1 }}" />
                          <button type="button" class="btn-secondary remove-part-row">Remover</button>
                        </div>
                        {% endfor %}
                      {% else %}
                        <div class="maintenance-part-row">
                          <select name="maintenance_part_id[]">
                            <option value="">Sem troca de pe√ßa</option>
                            {% for product in products %}
                            <option value="{{ product.id }}">{{ product.name }}</option>
                            {% endfor %}
                          </select>
                          <input name="maintenance_part_qty[]" type="number" min="1" value="1" />
                          <button type="button" class="btn-secondary remove-part-row" hidden>Remover</button>
                        </div>
                      {% endif %}
                    </div>
                    <button type="button" class="btn-secondary add-edit-maintenance-part" style="margin-top:8px;">+ Adicionar pe√ßa</button>
                  </div>
                  <button type="submit" class="btn-secondary">Salvar altera√ß√µes</button>
                </form>
              </details>
              <button type="button" class="btn-secondary js-print-trigger" data-print-url="{{ url_for('imprimir', tipo='manutencao', record_id=ticket.id) }}">üñ®Ô∏è Imprimir OS</button>
              <form method="post" action="{{ url_for('atualizar_manutencao', ticket_id=ticket.id) }}">
                <input type="hidden" name="action" value="finalizar" />
                <button type="submit" class="btn-success">‚úÖ Finalizar e enviar ao hist√≥rico</button>
              </form>
            </div>
          </details>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="6">Nenhum equipamento em manuten√ß√£o ativa.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<section class="card services-shell">
  <h2>Pronto para retirada (aguardando pagamento/retirada)</h2>
  <table>
    <thead>
      <tr><th>Entrada</th><th>Cliente</th><th>Equipamento</th><th>Servi√ßo</th><th>Status</th><th>A√ß√µes</th></tr>
    </thead>
    <tbody>
      {% for ticket in ready_for_pickup_tickets %}
      {% set linked_service = maintenance_service_map.get(ticket.id) %}
      <tr>
        <td>{{ ticket.entry_date.strftime('%d/%m/%Y %H:%M') }}</td>
        <td>{{ ticket.client_name }}</td>
        <td>{{ ticket.equipment }}</td>
        <td>{{ ticket.service_description }}</td>
        <td><span class="badge success">{{ maintenance_status_labels.get(ticket.status, ticket.status) }}</span></td>
        <td>
          <details class="service-actions-menu">
            <summary>‚ãØ</summary>
            <div class="service-actions-list">
              <button type="button" class="btn-secondary js-print-trigger" data-print-url="{{ url_for('imprimir', tipo='manutencao', record_id=ticket.id) }}">üñ®Ô∏è Imprimir OS</button>
              {% if ticket.service_record_id %}
              <button type="button" class="btn-secondary js-print-trigger" data-print-url="{{ url_for('imprimir', tipo='servico', record_id=ticket.service_record_id) }}">üßæ Imprimir recibo</button>
              {% endif %}
              {% if linked_service %}
              <details>
                <summary>‚úèÔ∏è Editar servi√ßo</summary>
                <form method="post" action="{{ url_for('editar_servico', service_id=linked_service.id) }}" class="inline-form">
                  <input name="service_name" value="{{ linked_service.service_name }}" placeholder="Nome do servi√ßo" required />
                  <input name="client_name" value="{{ linked_service.client_name }}" placeholder="Cliente" required />
                  <input name="equipment" value="{{ linked_service.equipment }}" placeholder="Equipamento" required />
                  <input name="total_price" type="number" min="0" step="0.01" value="{{ '%.2f'|format(linked_service.total_price or 0) }}" />
                  <input name="cost" type="number" min="0" step="0.01" value="{{ '%.2f'|format(linked_service.cost or 0) }}" />
                  <textarea name="notes" rows="2" placeholder="Observa√ß√µes">{{ linked_service.notes or '' }}</textarea>
                  <button type="submit" class="btn-secondary">Salvar edi√ß√£o</button>
                </form>
              </details>
              <form method="post" action="{{ url_for('excluir_servico', service_id=linked_service.id) }}" onsubmit="return confirm('Deseja excluir este servi√ßo?');">
                <button type="submit" class="btn-loja btn-loja--danger">üóëÔ∏è Excluir servi√ßo</button>
              </form>
              {% endif %}
            </div>
          </details>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="6">Nenhuma OS pronta para retirada.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<section class="card services-shell">
  <div class="history-head">
    <h2>Hist√≥rico Unificado (Servi√ßos conclu√≠dos + OS conclu√≠das pagas e retiradas)</h2>
    <input id="service-history-search" type="search" placeholder="Buscar cliente, equipamento ou servi√ßo..." />
  </div>
  <table>
    <thead>
      <tr><th>Data</th><th>Origem</th><th>Servi√ßo</th><th>Cliente</th><th>Equipamento</th><th>Valor final</th><th>A√ß√µes</th></tr>
    </thead>
    <tbody id="service-history-body">
      {% for item in unified_completed_history %}
      {% set service = item.service %}
      <tr>
        <td>{{ item.date.strftime('%d/%m/%Y %H:%M') if item.date else '-' }}</td>
        <td>{% if item.type == 'os_concluida' %}OS conclu√≠da{% else %}Servi√ßo avulso{% endif %}</td>
        <td>{{ item.service_name }}</td>
        <td>{{ item.client_name }}</td>
        <td>{{ item.equipment }}</td>
        <td>R$ {{ '%.2f'|format(item.total_price or 0) }}</td>
        <td>
          <details class="service-actions-menu">
            <summary>‚ãØ</summary>
            <div class="service-actions-list">
              {% if item.ticket %}
              <button type="button" class="btn-secondary js-print-trigger" data-print-url="{{ url_for('imprimir', tipo='manutencao', record_id=item.ticket.id) }}">üñ®Ô∏è Imprimir OS</button>
              {% endif %}
              {% if service %}
              <button type="button" class="btn-secondary js-print-trigger" data-print-url="{{ url_for('imprimir', tipo='servico', record_id=service.id) }}">üßæ Imprimir recibo</button>
              <details>
                <summary>‚úèÔ∏è Editar servi√ßo</summary>
                <form method="post" action="{{ url_for('editar_servico', service_id=service.id) }}" class="inline-form">
                  <input name="service_name" value="{{ service.service_name }}" placeholder="Nome do servi√ßo" required />
                  <input name="client_name" value="{{ service.client_name }}" placeholder="Cliente" required />
                  <input name="equipment" value="{{ service.equipment }}" placeholder="Equipamento" required />
                  <input name="total_price" type="number" min="0" step="0.01" value="{{ '%.2f'|format(service.total_price or 0) }}" />
                  <input name="cost" type="number" min="0" step="0.01" value="{{ '%.2f'|format(service.cost or 0) }}" />
                  <textarea name="notes" rows="2" placeholder="Observa√ß√µes">{{ service.notes or '' }}</textarea>
                  <button type="submit" class="btn-secondary">Salvar edi√ß√£o</button>
                </form>
              </details>
              <form method="post" action="{{ url_for('excluir_servico', service_id=service.id) }}" onsubmit="return confirm('Deseja excluir este servi√ßo?');">
                <button type="submit" class="btn-loja btn-loja--danger">üóëÔ∏è Excluir servi√ßo</button>
              </form>
              {% endif %}
            </div>
          </details>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="7">Nenhum servi√ßo conclu√≠do cadastrado.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<script>
  const historySearch = document.getElementById('service-history-search');
  const historyRows = Array.from(document.querySelectorAll('#service-history-body tr'));

  historySearch?.addEventListener('input', () => {
    const term = historySearch.value.toLowerCase().trim();
    historyRows.forEach((row) => {
      const show = row.textContent.toLowerCase().includes(term);
      row.style.display = show ? '' : 'none';
    });
  });



  const clonePartRow = (sourceRow) => {
    const clone = sourceRow.cloneNode(true);
    clone.querySelectorAll('select, input').forEach((field) => {
      if (field.tagName === 'SELECT') field.value = '';
      if (field.tagName === 'INPUT') field.value = '1';
    });
    return clone;
  };

  document.querySelectorAll('.service-edit-form').forEach((form) => {
    const partsContainer = form.querySelector('.edit-maintenance-parts-list');
    const addBtn = form.querySelector('.add-edit-maintenance-part');
    if (!partsContainer || !addBtn) return;

    const updateButtons = () => {
      const rows = Array.from(partsContainer.querySelectorAll('.maintenance-part-row'));
      rows.forEach((row) => {
        const removeBtn = row.querySelector('.remove-part-row');
        if (!removeBtn) return;
        removeBtn.hidden = rows.length === 1;
        removeBtn.onclick = () => {
          row.remove();
          updateButtons();
        };
      });
    };

    addBtn.addEventListener('click', () => {
      const firstRow = partsContainer.querySelector('.maintenance-part-row');
      if (!firstRow) return;
      partsContainer.appendChild(clonePartRow(firstRow));
      updateButtons();
    });

    updateButtons();
  });
  const partsList = document.getElementById('maintenance-parts-list');
  const addPartButton = document.getElementById('add-maintenance-part');

  const updatePartButtons = () => {
    const rows = Array.from(partsList?.querySelectorAll('.maintenance-part-row') || []);
    rows.forEach((row, index) => {
      const removeButton = row.querySelector('.remove-part-row');
      if (!removeButton) return;
      removeButton.hidden = rows.length === 1;
      removeButton.onclick = () => {
        row.remove();
        updatePartButtons();
      };
    });
  };

  addPartButton?.addEventListener('click', () => {
    const firstRow = partsList?.querySelector('.maintenance-part-row');
    if (!firstRow || !partsList) return;
    const clone = firstRow.cloneNode(true);
    clone.querySelectorAll('select, input').forEach((field) => {
      if (field.tagName === 'SELECT') field.value = '';
      if (field.tagName === 'INPUT') field.value = '1';
    });
    partsList.appendChild(clone);
    updatePartButtons();
  });

  updatePartButtons();
</script>
{% endblock %}

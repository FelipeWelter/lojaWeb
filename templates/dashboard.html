{% extends 'base.html' %}
{% block content %}
<section class="card">
  <h2>Filtro de período</h2>
  <form method="get" class="grid form-grid">
    <select name="period">
      <option value="today" {% if period == 'today' %}selected{% endif %}>Hoje</option>
      <option value="7d" {% if period == '7d' %}selected{% endif %}>Últimos 7 dias</option>
      <option value="month" {% if period == 'month' %}selected{% endif %}>Mês atual</option>
    </select>
    <button type="submit">Aplicar filtro</button>
  </form>
</section>

<section class="dashboard-kpis">
  <article class="card kpi-card">
    <h3>Produtos cadastrados</h3>
    <strong>{{ product_count }}</strong>
  </article>
  <article class="card kpi-card kpi-stock">
    <h3>Itens em estoque</h3>
    <strong>{{ total_stock }}</strong>
  </article>
  <article class="card kpi-card kpi-sales">
    <h3>Total em vendas</h3>
    <strong id="kpi-total-vendas">R$ {{ '%.2f'|format(total_sales_amount) }}</strong>
  </article>
  <article class="card kpi-card">
    <h3>Serviços realizados</h3>
    <strong>{{ services_count }}</strong>
  </article>
  <article class="card kpi-card">
    <h3>Vendas registradas</h3>
    <strong>{{ sales_count }}</strong>
  </article>
  <article class="card kpi-card">
    <h3>Total em serviços</h3>
    <strong>R$ {{ '%.2f'|format(total_services_amount) }}</strong>
  </article>
  <article class="card kpi-card kpi-profit">
    <h3>Lucro estimado</h3>
    <strong id="kpi-lucro-estimado">R$ {{ '%.2f'|format(total_profit) }}</strong>
  </article>
  <article class="card kpi-card">
    <h3>Custos fixos</h3>
    <strong>R$ {{ '%.2f'|format(total_fixed_costs) }}</strong>
  </article>
  <article class="card kpi-card">
    <h3>Lucro realizado líquido</h3>
    <strong>R$ {{ '%.2f'|format(net_profit) }}</strong>
  </article>
  <article class="card kpi-card">
    <h3>Cobranças pendentes</h3>
    <strong>{{ pending_charges }}</strong>
  </article>
  <article class="card kpi-card">
    <h3>Pendente para receber</h3>
    <strong>R$ {{ '%.2f'|format(pending_receivable_total) }}</strong>
  </article>
  <article class="card kpi-card">
    <h3>Manutenções ativas</h3>
    <strong>{{ maintenance_in_progress }}</strong>
  </article>
  <article class="card kpi-card">
    <h3>Aguardando peças</h3>
    <strong>{{ maintenance_waiting_parts }}</strong>
  </article>
</section>

<section class="dashboard-actions card">
  <h2>Relatório diário</h2>
  <button type="button" id="btn-print-report">Imprimir Relatório do Dia</button>
</section>

<section class="card">
  <h2>Financeiro: custos fixos</h2>
  <form method="post" action="{{ url_for('cadastrar_custo_fixo') }}" class="grid form-grid">
    <input name="description" placeholder="Descrição (ex: aluguel, energia)" required />
    <input name="amount" type="number" min="0" step="0.01" placeholder="Valor" required />
    <button type="submit">Cadastrar custo fixo</button>
  </form>
</section>

<section class="dashboard-charts">
  <article class="card chart-card">
    <h2>Vendas por mês</h2>
    <canvas id="sales-line-chart" height="100"></canvas>
  </article>

  <article class="card chart-card pie-card">
    <h2>Produtos mais vendidos</h2>
    <div class="pie-wrapper">
      <canvas id="top-products-chart" height="100"></canvas>
    </div>
  </article>
</section>

<section class="card">
  <h2>Vendas por forma de pagamento</h2>
  <table class="printable-table">
    <thead><tr><th>Forma de pagamento</th><th>Qtd. cobranças</th><th>Total</th></tr></thead>
    <tbody>
      {% for method, count, amount in payment_method_summary %}
      <tr>
        <td>{{ payment_method_labels.get(method, method|capitalize) }}</td>
        <td>{{ count }}</td>
        <td>R$ {{ '%.2f'|format(amount) }}</td>
      </tr>
      {% else %}
      <tr><td colspan="3">Nenhuma cobrança registrada ainda.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<section class="card no-print">
  <h2>Últimas vendas</h2>
  <table>
    <thead><tr><th>Data</th><th>Cliente</th><th>Itens</th><th>Qtd. linhas</th><th>Total</th><th>Status</th><th>Ação</th></tr></thead>
    <tbody>
      {% for sale in latest_sales %}
      <tr>
        <td>{{ sale.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
        <td>{{ sale.client.name }}</td>
        <td>{% if sale.items %}{{ sale.items[0].description }}{% else %}{{ sale.product.name }}{% endif %}</td>
        <td>{% if sale.items %}{{ sale.items|length }}{% else %}{{ sale.quantity }}{% endif %}</td>
        <td>R$ {{ '%.2f'|format(sale.total) }}</td>
        <td>
          {% if sale.canceled %}
          <span class="badge danger">Cancelada</span>
          {% elif sale.id in finalized_sales %}
          <span class="badge success">Finalizada</span>
          {% else %}
          <span class="badge">Pendente</span>
          {% endif %}
        </td>
        <td>
          {% if sale.canceled %}
          <form method="post" action="{{ url_for('excluir_venda', sale_id=sale.id) }}" onsubmit="return confirm('Excluir esta venda cancelada do histórico inicial?');">
            <button type="submit" class="btn-danger">Excluir</button>
          </form>
          {% else %}-{% endif %}
        </td>
      </tr>
      {% else %}
      <tr><td colspan="7">Nenhuma venda registrada ainda.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<section class="card no-print">
  <h2>Últimos serviços</h2>
  <table>
    <thead><tr><th>Data</th><th>Cliente</th><th>Serviço</th><th>Total</th><th>Status</th></tr></thead>
    <tbody>
      {% for service in latest_services %}
      <tr>
        <td>{{ service.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
        <td>{{ service.client_name }}</td>
        <td>{{ service.service_name }}</td>
        <td>R$ {{ '%.2f'|format(service.total_price) }}</td>
        <td>
          {% if service.id in finalized_services %}
          <span class="badge success">Finalizada</span>
          {% else %}
          <span class="badge">Pendente</span>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr><td colspan="5">Nenhum serviço registrado ainda.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const months = {{ chart_months|tojson }};
  const salesTotals = {{ chart_sales_totals|tojson }};
  const topLabels = {{ top_products_labels|tojson }};
  const topValues = {{ top_products_values|tojson }};

  const lineCtx = document.getElementById('sales-line-chart');
  if (lineCtx) {
    new Chart(lineCtx, {
      type: 'line',
      data: {
        labels: months,
        datasets: [{
          label: 'Vendas (R$)',
          data: salesTotals,
          borderColor: '#3498DB',
          backgroundColor: 'rgba(52, 152, 219, 0.22)',
          tension: 0.25,
          fill: true,
        }],
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
      },
    });
  }

  const pieCtx = document.getElementById('top-products-chart');
  if (pieCtx) {
    new Chart(pieCtx, {
      type: 'pie',
      data: {
        labels: topLabels,
        datasets: [{
          data: topValues,
          backgroundColor: ['#3498DB', '#5dade2', '#85c1e9', '#aed6f1', '#d6eaf8'],
        }],
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
      },
    });
  }

  const printButton = document.getElementById('btn-print-report');
  if (printButton) {
    printButton.addEventListener('click', () => {
      window.print();
    });
  }
</script>
{% endblock %}

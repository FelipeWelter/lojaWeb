{% extends 'base.html' %}
{% block content %}
<section class="card">
  <div class="inventory-header"><h2>Novo produto</h2><a class="btn-secondary" href="{{ url_for('montar_pc') }}">Montar/Cadastrar PC</a></div>


  <form method="post" class="grid form-grid piece-form-grid" id="piece-form" enctype="multipart/form-data">
    <input type="hidden" name="form_mode" value="piece" />
    <div class="product-zone-grid full-width">
      <section class="form-zone zone-identity">
        <h3>Dados principais</h3>
        <label>Nome do produto<input name="name" placeholder="Nome" required /></label>
        <label>Marca<input name="brand" placeholder="Marca" /></label>
        <label>Categoria
          <select name="category" id="category-select"><option>Peça</option><option>Computador</option></select>
        </label>
      </section>

      <section class="form-zone zone-finance">
        <h3>Valores de venda</h3>
        <label>Custo unitário<div class="money-wrap"><input name="cost_price" id="cost-input" type="number" min="0" step="0.01" placeholder="Custo unitário" required /></div></label>
        <label>Preço de venda<div class="money-wrap"><input name="price" id="price-input" type="number" min="0" step="0.01" placeholder="Preço de venda" required /></div></label>
        <label>Margem de lucro<span id="margin-pill" class="margin-pill ok">0%</span><input name="margin_percent" id="margin-input" type="number" min="-100" step="0.01" value="0" readonly /></label>
      </section>

      <section class="form-zone zone-logistics">
        <h3>Controle de estoque</h3>
        <label>Estoque atual<input name="stock" type="number" min="0" placeholder="Estoque" required /></label>
        <label>Estoque mínimo<input name="min_stock" type="number" min="0" placeholder="0" value="0" /></label>
        <label>Unidade de medida<input name="unit_measure" placeholder="Ex: un, kit" value="un" /></label>
      </section>

      <section class="form-zone zone-meta">
        <h3>Dados técnicos</h3>
        <label>Classe da peça
          <select name="component_class" id="component-class-select">
            <option value="">Classe da peça (opcional)</option>
            <option value="gabinete">Gabinete</option>
            <option value="fans">Fans</option>
            <option value="placa_mae">Placa-mãe</option>
            <option value="placa_video">Placa de Vídeo</option>
            <option value="processador">Processador</option>
            <option value="memoria_ram">Memória RAM</option>
            <option value="armazenamento">Armazenamento</option>
            <option value="fonte">Fonte</option>
          </select>
        </label>
        <label>Frete/Taxas<div class="money-wrap"><input name="freight_fees" id="freight-input" type="number" min="0" step="0.01" placeholder="Frete/Taxas" value="0" /></div></label>
        <label>Número de Série (S/N)<input name="serial_number" placeholder="Número de Série (S/N)" /></label>
      </section>

      <section class="form-zone zone-media full-width">
        <h3>Mídia do produto</h3>
        <label class="media-upload-field">Imagem do produto<input name="photo_file" type="file" accept="image/*" /></label>
      </section>
    </div>
    <button type="submit">Salvar peça</button>
  </form>

</section>



<script>
  const categorySelect = document.getElementById('category-select');
  const classSelect = document.getElementById('component-class-select');

  function togglePieceClass() {
    const isPiece = categorySelect.value === 'Peça';
    classSelect.disabled = !isPiece;
    if (!isPiece) classSelect.value = '';
  }

  function updateMarginRealtime() {
    const cost = Number(document.getElementById('cost-input')?.value || 0);
    const freight = Number(document.getElementById('freight-input')?.value || 0);
    const price = Number(document.getElementById('price-input')?.value || 0);
    const base = cost + freight;
    const margin = base > 0 ? ((price - base) / base) * 100 : 0;
    const marginInput = document.getElementById('margin-input');
    const pill = document.getElementById('margin-pill');
    if (marginInput) marginInput.value = margin.toFixed(2);
    if (!pill) return;
    pill.textContent = `${margin.toFixed(2)}%`;
    pill.classList.remove('ok','warn','bad');
    if (margin < 0) pill.classList.add('bad');
    else if (margin < 10) pill.classList.add('warn');
    else pill.classList.add('ok');
  }

  categorySelect.addEventListener('change', togglePieceClass);
  document.getElementById('cost-input')?.addEventListener('input', updateMarginRealtime);
  document.getElementById('freight-input')?.addEventListener('input', updateMarginRealtime);
  document.getElementById('price-input')?.addEventListener('input', updateMarginRealtime);
  togglePieceClass();
  updateMarginRealtime();
</script>
{% endblock %}

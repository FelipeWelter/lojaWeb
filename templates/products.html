{% extends 'base.html' %}
{% block content %}
<section class="card">
  <h2>Novo produto</h2>

  <div class="class-menu" id="new-product-mode-menu">
    <button type="button" class="active" data-mode="piece">Cadastrar peça</button>
    <button type="button" data-mode="assembled">Cadastrar computador montado</button>
  </div>

  <form method="post" class="grid form-grid piece-form-grid" id="piece-form" enctype="multipart/form-data">
    <input type="hidden" name="form_mode" value="piece" />
    <input name="name" placeholder="Nome" required />
    <select name="category" id="category-select"><option>Peça</option><option>Computador</option></select>
    <select name="component_class" id="component-class-select">
      <option value="">Classe da peça (opcional)</option>
      <option value="gabinete">Gabinete</option>
      <option value="placa_mae">Placa-mãe</option>
      <option value="placa_video">Placa de Vídeo</option>
      <option value="processador">Processador</option>
      <option value="memoria_ram">Memória RAM</option>
      <option value="armazenamento">Armazenamento</option>
      <option value="fonte">Fonte</option>
    </select>
    <input name="stock" type="number" min="0" placeholder="Estoque" required />
    <input name="price" type="number" min="0" step="0.01" placeholder="Preço de venda" required />
    <input name="cost_price" type="number" min="0" step="0.01" placeholder="Valor de compra" required />
    <input name="serial_number" placeholder="Número de Série (S/N)" />
    <input name="photo_file" type="file" accept="image/*" />
    <button type="submit">Salvar peça</button>
  </form>

  <form method="post" class="grid form-grid hidden" id="assembled-form" enctype="multipart/form-data">
    <input type="hidden" name="form_mode" value="assembled_computer" />

    <div class="pc-header full-width">
      <label>
        Nome do computador
        <input name="computer_name" placeholder="Ex: Setup Gamer RTX" required />
      </label>
      <label>
        Preço base (opcional)
        <input name="computer_original_price" type="number" min="0" step="0.01" placeholder="0,00" />
      </label>
      <label>
        Fotos do computador
        <input name="photo_files" type="file" accept="image/*" multiple />
      </label>
    </div>

    <div class="slots-top full-width">
      {% for slot_key, slot_label, allow_multiple in component_slots if not allow_multiple %}
      <div class="slot-box">
        <h3>{{ slot_label }}</h3>
        <p class="slot-help">Selecione uma peça desta classe (opcional).</p>
        <label>
          Seleção
          <select name="slot_{{ slot_key }}" class="piece-select">
            <option value="">Sem seleção</option>
            {% for part in parts_by_class[slot_key] %}
            <option value="{{ part.id }}" data-cost="{{ part.price }}" {% if part.stock <= 0 %}disabled{% endif %}>
              {{ part.name }} (R$ {{ '%.2f'|format(part.price) }}, estoque: {{ part.stock }})
            </option>
            {% endfor %}
          </select>
        </label>
        <label>
          Ou peça personalizada
          <input name="custom_{{ slot_key }}_name" placeholder="Ex: item fora do estoque" />
        </label>
        <label>
          Custo (R$)
          <input name="custom_{{ slot_key }}_cost" type="number" min="0" step="0.01" placeholder="0,00" />
        </label>
      </div>
      {% endfor %}
    </div>

    <div class="slots-bottom full-width">
      {% for slot_key, slot_label, allow_multiple in component_slots if allow_multiple %}
      <div class="slot-box slot-multiple">
        <h3>{{ slot_label }}</h3>
        <p class="slot-help">Pode adicionar várias peças e quantidades.</p>
        <div class="multi-list" data-slot="{{ slot_key }}">
          <div class="multi-header">
            <span>Item</span>
            <span>Quantidade</span>
            <span></span>
          </div>

          <div class="multi-row">
            <select name="{{ slot_key }}_ids[]" class="piece-select">
              <option value="">Sem seleção</option>
              {% for part in parts_by_class[slot_key] %}
              <option value="{{ part.id }}" data-cost="{{ part.price }}" {% if part.stock <= 0 %}disabled{% endif %}>
                {{ part.name }} (R$ {{ '%.2f'|format(part.price) }}, estoque: {{ part.stock }})
              </option>
              {% endfor %}
            </select>
            <input name="{{ slot_key }}_custom_names[]" placeholder="Ou peça personalizada" />
            <input name="{{ slot_key }}_custom_costs[]" type="number" min="0" step="0.01" placeholder="Custo" />

            <div class="qty-control" title="Quantidade">
              <button type="button" class="qty-btn qty-decrease" aria-label="Diminuir">−</button>
              <input type="number" name="{{ slot_key }}_qtys[]" min="1" value="1" />
              <button type="button" class="qty-btn qty-increase" aria-label="Aumentar">+</button>
            </div>

            <button type="button" class="row-remove" title="Remover linha" aria-label="Remover linha">✕</button>
          </div>
        </div>
        <button type="button" class="add-item" data-slot="{{ slot_key }}">＋ Adicionar {{ slot_label }}</button>
      </div>
      {% endfor %}
    </div>

    <div class="assembly-summary full-width">
      <p><strong>Custo total das peças:</strong> <span id="total-custo">R$ 0,00</span></p>
      <p><strong>Preço sugerido (+20%):</strong> <span id="preco-sugerido">R$ 0,00</span></p>
    </div>

    <div class="assembly-summary full-width">
      <label>
        Observações técnicas
        <textarea name="technical_notes" rows="3" placeholder="Detalhes técnicos e validações..."></textarea>
      </label>
      <div class="class-menu">
        <label><input type="checkbox" name="bios_updated" /> BIOS atualizada</label>
        <label><input type="checkbox" name="stress_test_done" /> Stress test realizado</label>
        <label><input type="checkbox" name="os_installed" /> Sistema operacional instalado</label>
        <label><input type="checkbox" name="create_stock_item" checked /> Criar automaticamente item em estoque</label>
      </div>
    </div>

    <button type="submit">Salvar computador montado</button>
  </form>
</section>

<section class="card">
  <h2>Estoque atual</h2>
  <div class="class-menu stock-filter-menu" id="class-menu">
    <button type="button" class="active" data-filter="all">Todos</button>
    <button type="button" data-filter="computador">Computadores</button>
    <button type="button" data-filter="gabinete">Gabinete</button>
    <button type="button" data-filter="placa_mae">Placa-mãe</button>
    <button type="button" data-filter="placa_video">Placa de Vídeo</button>
    <button type="button" data-filter="processador">Processador</button>
    <button type="button" data-filter="memoria_ram">Memória RAM</button>
    <button type="button" data-filter="armazenamento">Armazenamento</button>
    <button type="button" data-filter="fonte">Fonte</button>
  </div>
  <div class="stock-print-actions">
    <form method="post" action="{{ url_for('imprimir_etiquetas_produtos') }}" class="stock-print-form">
      <button type="submit" class="btn-secondary">Imprimir Etiquetas</button>
      <small>Seleciona os itens filtrados para gerar etiquetas com Nome, Venda e S/N.</small>
    </form>
    <form method="post" action="{{ url_for('imprimir_inventario_produtos') }}" class="stock-print-form">
      <button type="submit" class="btn-secondary">Imprimir Inventário</button>
      <small>Relatório para balanço sem colunas de ações e foto.</small>
    </form>
  </div>
  <div class="table-wrap stock-table-wrap">
  <table class="stock-table">
    <thead><tr><th>Sel.</th><th>Produto</th><th>Categoria</th><th>Classe</th><th>S/N</th><th>Estoque</th><th>Compra</th><th>Venda</th><th>Foto</th><th>Ações</th></tr></thead>
    <tbody>
      {% for p in products %}
      {% set bucket = 'computador' if p.category == 'Computador' else (p.component_class or 'sem_classe') %}
      <tr data-bucket="{{ bucket }}" data-product-id="{{ p.id }}">
        <td><input type="checkbox" class="label-select" name="selected_products" value="{{ p.id }}" /></td>
        <td>{{ p.name }}</td>
        <td>{{ p.category }}</td>
        <td>{{ p.component_class or '-' }}</td>
        <td>{{ p.serial_number or '-' }}</td>
        <td>{{ p.stock }}</td>
        <td>R$ {{ '%.2f'|format(p.cost_price) }}</td>
        <td>R$ {{ '%.2f'|format(p.price) }}</td>
        <td>
          {% set gallery = p.images if p.images else [] %}
          {% if gallery %}
            <img src="{{ gallery[0].image_url }}" alt="Foto de {{ p.name }}" class="stock-thumb" loading="lazy" />
            <small>{{ gallery|length }} foto(s)</small>
          {% elif p.photo_url %}
            <a href="{{ p.photo_url }}" target="_blank" title="Abrir imagem">
              <img src="{{ p.photo_url }}" alt="Foto de {{ p.name }}" class="stock-thumb" loading="lazy" />
            </a>
          {% else %}-{% endif %}
        </td>
        <td>
          <div class="table-actions">
            <button type="button" class="btn-secondary open-edit-modal" data-modal-id="edit-modal-{{ p.id }}">Editar</button>
            <form method="post" action="{{ url_for('remover_produto', product_id=p.id) }}" onsubmit="return confirm('Deseja remover este item do estoque?');">
              <button type="submit" class="btn-danger">Remover</button>
            </form>
          </div>
        </td>
      </tr>

      <dialog id="edit-modal-{{ p.id }}" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3>Editar {{ p.name }}</h3>
            <button type="button" class="modal-close" data-close-modal="edit-modal-{{ p.id }}">✕</button>
          </div>

          <div class="action-stack">
            <form method="post" action="{{ url_for('editar_produto', product_id=p.id) }}" class="inline-form">
              <input name="name" value="{{ p.name }}" required />
              <select name="category">
                <option value="Peça" {% if p.category == 'Peça' %}selected{% endif %}>Peça</option>
                <option value="Computador" {% if p.category == 'Computador' %}selected{% endif %}>Computador</option>
              </select>
              <select name="component_class">
                <option value="">Sem classe</option>
                <option value="gabinete" {% if p.component_class == 'gabinete' %}selected{% endif %}>Gabinete</option>
                <option value="placa_mae" {% if p.component_class == 'placa_mae' %}selected{% endif %}>Placa-mãe</option>
                <option value="placa_video" {% if p.component_class == 'placa_video' %}selected{% endif %}>Placa de Vídeo</option>
                <option value="processador" {% if p.component_class == 'processador' %}selected{% endif %}>Processador</option>
                <option value="memoria_ram" {% if p.component_class == 'memoria_ram' %}selected{% endif %}>Memória RAM</option>
                <option value="armazenamento" {% if p.component_class == 'armazenamento' %}selected{% endif %}>Armazenamento</option>
                <option value="fonte" {% if p.component_class == 'fonte' %}selected{% endif %}>Fonte</option>
              </select>
              <input name="stock" type="number" min="0" value="{{ p.stock }}" required />
              <input name="cost_price" type="number" min="0" step="0.01" value="{{ p.cost_price }}" required />
              <input name="serial_number" value="{{ p.serial_number or "" }}" placeholder="Número de Série (S/N)" />
              <input name="price" type="number" min="0" step="0.01" value="{{ p.price }}" required />
              <button type="submit">Salvar alterações</button>
            </form>

            <div class="product-gallery" data-gallery-id="gallery-{{ p.id }}">
              {% if p.images %}
                {% for img in p.images %}
                <img src="{{ img.image_url }}" alt="Imagem {{ loop.index }} de {{ p.name }}" class="gallery-image {% if not loop.first %}hidden{% endif %}" data-index="{{ loop.index0 }}" />
                {% endfor %}
                <div class="gallery-controls">
                  <button type="button" class="btn-secondary gallery-prev" data-gallery-id="gallery-{{ p.id }}">◀</button>
                  <span class="gallery-counter" data-gallery-counter="gallery-{{ p.id }}">1 / {{ p.images|length }}</span>
                  <button type="button" class="btn-secondary gallery-next" data-gallery-id="gallery-{{ p.id }}">▶</button>
                </div>
              {% elif p.photo_url %}
                <img src="{{ p.photo_url }}" alt="Foto de {{ p.name }}" class="gallery-image" />
              {% else %}
                <p class="slot-help">Sem fotos cadastradas.</p>
              {% endif %}
            </div>

            <form method="post" action="{{ url_for('atualizar_foto_produto', product_id=p.id) }}" class="inline-form" enctype="multipart/form-data">
              <input name="photo_files" type="file" accept="image/*" multiple required />
              <button type="submit">Adicionar fotos na galeria</button>
            </form>

          </div>
        </div>
      </dialog>
      {% else %}<tr><td colspan="10">Sem produtos.</td></tr>{% endfor %}
    </tbody>
  </table>
  </div>
</section>
<script>
  const categorySelect = document.getElementById('category-select');
  const classSelect = document.getElementById('component-class-select');
  const menu = document.getElementById('class-menu');
  const modeMenu = document.getElementById('new-product-mode-menu');
  const pieceForm = document.getElementById('piece-form');
  const assembledForm = document.getElementById('assembled-form');
  const custoEl = document.getElementById('total-custo');
  const precoEl = document.getElementById('preco-sugerido');

  function togglePieceClass() {
    const isPiece = categorySelect.value === 'Peça';
    classSelect.disabled = !isPiece;
    if (!isPiece) classSelect.value = '';
  }

  function syncPrintSelections() {
    const selectedIds = [...document.querySelectorAll('tbody .label-select:checked')].map((el) => el.value);
    document.querySelectorAll('.stock-print-form').forEach((form) => {
      form.querySelectorAll('input[name="product_ids"]').forEach((input) => input.remove());
      selectedIds.forEach((id) => {
        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'product_ids';
        hidden.value = id;
        form.appendChild(hidden);
      });
    });
  }

  function applyFilter(bucket) {
    document.querySelectorAll('tbody tr[data-bucket]').forEach((row) => {
      row.style.display = bucket === 'all' || row.dataset.bucket === bucket ? '' : 'none';
    });
    syncPrintSelections();
  }

  function setMode(mode) {
    const isPieceMode = mode === 'piece';
    pieceForm.classList.toggle('hidden', !isPieceMode);
    assembledForm.classList.toggle('hidden', isPieceMode);

    modeMenu.querySelectorAll('button').forEach((button) => {
      button.classList.toggle('active', button.dataset.mode === mode);
    });
  }

  function formatBRL(value) {
    return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  function atualizarTotaisMontado() {
    let total = 0;
    assembledForm.querySelectorAll('.multi-row').forEach((row) => {
      const select = row.querySelector('select');
      const qtyInput = row.querySelector('input[type="number"]');
      const customNameInput = row.querySelector('input[name$="_custom_names[]"]');
      const customCostInput = row.querySelector('input[name$="_custom_costs[]"]');
      const option = select.options[select.selectedIndex];
      const qty = Number(qtyInput.value || 0);
      if (option && option.value && qty > 0) {
        total += Number(option.dataset.cost || 0) * qty;
      } else if (customNameInput && customNameInput.value.trim() && qty > 0) {
        total += Number(customCostInput.value || 0) * qty;
      }
    });

    assembledForm.querySelectorAll('.slot-box select[name^="slot_"]').forEach((select) => {
      const option = select.options[select.selectedIndex];
      if (option && option.value) {
        total += Number(option.dataset.cost || 0);
      } else {
        const slot = select.name.replace('slot_', '');
        const name = assembledForm.querySelector(`input[name="custom_${slot}_name"]`);
        const cost = assembledForm.querySelector(`input[name="custom_${slot}_cost"]`);
        if (name && name.value.trim()) total += Number(cost.value || 0);
      }
    });

    const sugerido = total * 1.2;
    custoEl.textContent = formatBRL(total);
    precoEl.textContent = formatBRL(sugerido);
  }

  menu.querySelectorAll('button').forEach((btn) => {
    btn.addEventListener('click', () => {
      menu.querySelectorAll('button').forEach((b) => b.classList.remove('active'));
      btn.classList.add('active');
      applyFilter(btn.dataset.filter);
    });
  });

  modeMenu.querySelectorAll('button').forEach((btn) => {
    btn.addEventListener('click', () => setMode(btn.dataset.mode));
  });

  assembledForm.querySelectorAll('.add-item').forEach((btn) => {
    btn.addEventListener('click', () => {
      const slot = btn.dataset.slot;
      const list = assembledForm.querySelector(`.multi-list[data-slot="${slot}"]`);
      const firstRow = list.querySelector('.multi-row');
      const clone = firstRow.cloneNode(true);
      clone.querySelector('select').selectedIndex = 0;
      const customName = clone.querySelector('input[name$="_custom_names[]"]');
      const customCost = clone.querySelector('input[name$="_custom_costs[]"]');
      const qtyInput = clone.querySelector('input[name$="_qtys[]"]');
      if (customName) customName.value = '';
      if (customCost) customCost.value = "";
      if (qtyInput) qtyInput.value = 1;
      list.appendChild(clone);
      atualizarTotaisMontado();
    });
  });

  document.querySelectorAll('.open-edit-modal').forEach((btn) => {
    btn.addEventListener('click', () => {
      const modal = document.getElementById(btn.dataset.modalId);
      if (modal) modal.showModal();
    });
  });

  document.querySelectorAll('[data-close-modal]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const modal = document.getElementById(btn.dataset.closeModal);
      if (modal) modal.close();
    });
  });

  document.querySelectorAll('dialog.modal').forEach((modal) => {
    modal.addEventListener('click', (event) => {
      const rect = modal.getBoundingClientRect();
      const clickedBackdrop =
        event.clientX < rect.left ||
        event.clientX > rect.right ||
        event.clientY < rect.top ||
        event.clientY > rect.bottom;
      if (clickedBackdrop) modal.close();
    });
  });

  assembledForm.addEventListener('click', (event) => {
    const target = event.target;

    if (target.classList.contains('qty-decrease') || target.classList.contains('qty-increase')) {
      const input = target.parentElement.querySelector('input[type="number"]');
      const current = Number(input.value || 1);
      const delta = target.classList.contains('qty-increase') ? 1 : -1;
      input.value = Math.max(1, current + delta);
      atualizarTotaisMontado();
    }

    if (target.classList.contains('row-remove')) {
      const list = target.closest('.multi-list');
      const rows = list.querySelectorAll('.multi-row');
      if (rows.length > 1) {
        target.closest('.multi-row').remove();
      } else {
        const row = rows[0];
        row.querySelector('select').selectedIndex = 0;
        row.querySelector('input[type="number"]').value = 1;
      }
      atualizarTotaisMontado();
    }
  });

  assembledForm.addEventListener('change', atualizarTotaisMontado);
  assembledForm.addEventListener('input', atualizarTotaisMontado);


  document.querySelectorAll('.gallery-prev, .gallery-next').forEach((btn) => {
    btn.addEventListener('click', () => {
      const galleryId = btn.dataset.galleryId;
      const container = document.querySelector(`[data-gallery-id="${galleryId}"]`);
      if (!container) return;
      const images = container.querySelectorAll('.gallery-image[data-index]');
      if (!images.length) return;

      let current = [...images].findIndex((img) => !img.classList.contains('hidden'));
      if (current < 0) current = 0;
      const next = btn.classList.contains('gallery-next')
        ? (current + 1) % images.length
        : (current - 1 + images.length) % images.length;

      images[current].classList.add('hidden');
      images[next].classList.remove('hidden');

      const counter = container.querySelector(`[data-gallery-counter="${galleryId}"]`);
      if (counter) counter.textContent = `${next + 1} / ${images.length}`;
    });
  });

  categorySelect.addEventListener('change', togglePieceClass);
  document.querySelectorAll('.label-select').forEach((input) => {
    input.addEventListener('change', syncPrintSelections);
  });
  togglePieceClass();
  syncPrintSelections();
  setMode('piece');
  atualizarTotaisMontado();
</script>
{% endblock %}

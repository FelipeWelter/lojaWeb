{% extends 'base.html' %}
{% block content %}
<section class="card">
  <h2>Novo produto</h2>
  <form method="post" class="grid form-grid" enctype="multipart/form-data">
    <input name="name" placeholder="Nome" required />
    <select name="category" id="category-select"><option>Peça</option><option>Computador</option></select>
    <select name="component_class" id="component-class-select">
      <option value="">Classe da peça (opcional)</option>
      <option value="gabinete">Gabinete</option>
      <option value="placa_mae">Placa-mãe</option>
      <option value="processador">Processador</option>
      <option value="memoria_ram">Memória RAM</option>
      <option value="armazenamento">Armazenamento</option>
      <option value="fonte">Fonte</option>
    </select>
    <input name="stock" type="number" min="0" placeholder="Estoque" required />
    <input name="price" type="number" min="0" step="0.01" placeholder="Preço" required />
    <input name="photo_file" type="file" accept="image/*" />
    <button type="submit">Salvar</button>
  </form>
</section>

<section class="card">
  <h2>Estoque atual</h2>
  <div class="class-menu" id="class-menu">
    <button type="button" class="active" data-filter="all">Todos</button>
    <button type="button" data-filter="computador">Computadores</button>
    <button type="button" data-filter="gabinete">Gabinete</button>
    <button type="button" data-filter="placa_mae">Placa-mãe</button>
    <button type="button" data-filter="processador">Processador</button>
    <button type="button" data-filter="memoria_ram">Memória RAM</button>
    <button type="button" data-filter="armazenamento">Armazenamento</button>
    <button type="button" data-filter="fonte">Fonte</button>
  </div>
  <table>
    <thead><tr><th>Produto</th><th>Categoria</th><th>Classe</th><th>Estoque</th><th>Preço</th><th>Foto</th><th>Atualizar foto</th></tr></thead>
    <tbody>
      {% for p in products %}
      {% set bucket = 'computador' if p.category == 'Computador' else (p.component_class or 'sem_classe') %}
      <tr data-bucket="{{ bucket }}">
        <td>{{ p.name }}</td><td>{{ p.category }}</td><td>{{ p.component_class or '-' }}</td><td>{{ p.stock }}</td><td>R$ {{ '%.2f'|format(p.price) }}</td>
        <td>
          {% if p.photo_url %}
            <a href="{{ p.photo_url }}" target="_blank" title="Abrir imagem">
              <img src="{{ p.photo_url }}" alt="Foto de {{ p.name }}" width="64" height="64" loading="lazy" />
            </a>
          {% else %}-{% endif %}
        </td>
        <td>
          <form method="post" action="{{ url_for('atualizar_foto_produto', product_id=p.id) }}" class="inline-form" enctype="multipart/form-data">
            <input name="photo_file" type="file" accept="image/*" required />
            <button type="submit">Atualizar</button>
          </form>
        </td>
      </tr>
      {% else %}<tr><td colspan="7">Sem produtos.</td></tr>{% endfor %}
    </tbody>
  </table>
</section>
<script>
  const categorySelect = document.getElementById('category-select');
  const classSelect = document.getElementById('component-class-select');
  const menu = document.getElementById('class-menu');

  function togglePieceClass() {
    const isPiece = categorySelect.value === 'Peça';
    classSelect.disabled = !isPiece;
    if (!isPiece) classSelect.value = '';
  }

  function applyFilter(bucket) {
    document.querySelectorAll('tbody tr[data-bucket]').forEach((row) => {
      row.style.display = bucket === 'all' || row.dataset.bucket === bucket ? '' : 'none';
    });
  }

  menu.querySelectorAll('button').forEach((btn) => {
    btn.addEventListener('click', () => {
      menu.querySelectorAll('button').forEach((b) => b.classList.remove('active'));
      btn.classList.add('active');
      applyFilter(btn.dataset.filter);
    });
  });

  categorySelect.addEventListener('change', togglePieceClass);
  togglePieceClass();
</script>
{% endblock %}

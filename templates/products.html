{% extends 'base.html' %}
{% block content %}
<section class="card">
  <div class="inventory-header product-header"><h2>Cadastro de produtos</h2><a class="btn-loja btn-loja--primary product-pc-button" href="{{ url_for('montar_pc') }}">üñ•Ô∏è Montar/Cadastrar PC</a></div>


  <form method="post" class="grid form-grid piece-form-grid" id="piece-form" enctype="multipart/form-data">
    <input type="hidden" name="form_mode" value="piece" />
    <div class="product-zone-grid full-width">
      <section class="form-zone zone-identity">
        <h3>Dados principais</h3>
        <label>Nome do produto<input name="name" placeholder="Nome" required /></label>
        <label>Marca<input name="brand" placeholder="Marca" /></label>
        <label>Categoria
          <select name="category" id="category-select"><option>Pe√ßa</option><option>Computador</option><option>Perif√©ricos</option></select>
        </label>
      </section>

      <section class="form-zone zone-finance">
        <h3>Valores de venda</h3>
        <label>Custo unit√°rio<div class="money-wrap"><input name="cost_price" id="cost-input" type="text" data-money="true" placeholder="0,00" required /></div></label>
        <label>Pre√ßo de venda<div class="money-wrap"><input name="price" id="price-input" type="text" data-money="true" placeholder="0,00" required /></div></label>
        <label>Margem de lucro (%)<span id="margin-pill" class="margin-pill ok">0,00%</span><input name="margin_percent" id="margin-input" type="text" value="0,00" readonly /></label>
      </section>

      <section class="form-zone zone-logistics">
        <h3>Controle de estoque</h3>
        <label>Estoque atual<input name="stock" type="number" min="0" placeholder="Estoque" required /></label>
        <label>Estoque m√≠nimo<input name="min_stock" type="number" min="0" placeholder="0" value="0" /></label>
        <label>Unidade de medida<input name="unit_measure" placeholder="Ex: un, kit" value="un" /></label>
      </section>

      <section class="form-zone zone-meta">
        <h3>Dados t√©cnicos</h3>
        <label>Classe da pe√ßa
          <select name="component_class" id="component-class-select">
            <option value="">Classe da pe√ßa (opcional)</option>
            <option value="gabinete">Gabinete</option>
            <option value="fans">Fans</option>
            <option value="placa_mae">Placa-m√£e</option>
            <option value="placa_video">Placa de V√≠deo</option>
            <option value="processador">Processador</option>
            <option value="memoria_ram">Mem√≥ria RAM</option>
            <option value="armazenamento">Armazenamento</option>
            <option value="fonte">Fonte</option>
            <option value="perifericos">Perif√©ricos</option>
          </select>
        </label>
        <label>Frete/Taxas<div class="money-wrap"><input name="freight_fees" id="freight-input" type="text" data-money="true" placeholder="0,00" value="0,00" /></div></label>
        <label>N√∫mero de S√©rie (S/N)<input name="serial_number" placeholder="N√∫mero de S√©rie (S/N)" /></label>

        <div id="ram-fields" class="component-extra-fields" hidden>
          <h4>Mem√≥ria RAM</h4>
          <label>Tecnologia (DDR)
            <select name="ram_ddr">
              <option value="">Selecione</option>
              <option value="DDR3">DDR3</option>
              <option value="DDR4">DDR4</option>
              <option value="DDR5">DDR5</option>
            </select>
          </label>
          <label>Marca<input name="ram_brand" placeholder="Ex: Kingston" /></label>
          <label>Frequ√™ncia<input name="ram_frequency" placeholder="Ex: 3200 MHz" /></label>
          <label>Tamanho<input name="ram_size" placeholder="Ex: 16 GB" /></label>
        </div>

        <div id="psu-fields" class="component-extra-fields" hidden>
          <h4>Fonte</h4>
          <label>Marca<input name="psu_brand" placeholder="Ex: Corsair" /></label>
          <label>Pot√™ncia (Watts)<input name="psu_watts" placeholder="Ex: 650W" /></label>
        </div>

        <div id="gpu-fields" class="component-extra-fields" hidden>
          <h4>Placa de v√≠deo</h4>
          <label>Mem√≥ria da placa<input name="gpu_memory" placeholder="Ex: 8 GB" /></label>
          <label>Marca<input name="gpu_brand" placeholder="Ex: ASUS" /></label>
          <label>Fabricante
            <select name="gpu_manufacturer">
              <option value="">Selecione</option>
              <option value="NVIDIA">NVIDIA</option>
              <option value="AMD">AMD</option>
              <option value="INTEL">INTEL</option>
            </select>
          </label>
        </div>

        <div id="storage-fields" class="component-extra-fields" hidden>
          <h4>Armazenamento</h4>
          <label>Tipo
            <select name="storage_type">
              <option value="">Selecione</option>
              <option value="HD">HD</option>
              <option value="SSD">SSD</option>
            </select>
          </label>
          <label>Capacidade<input name="storage_capacity" placeholder="Ex: 1 TB" /></label>
          <label>Marca<input name="storage_brand" placeholder="Ex: Western Digital" /></label>
        </div>
      </section>

      <section class="form-zone zone-media full-width">
        <h3>M√≠dia do produto</h3>
        <label class="media-upload-field">Imagem do produto<input name="photo_file" type="file" accept="image/*" /></label>
      </section>
    </div>
    <button type="submit">Salvar pe√ßa</button>
  </form>

</section>



<script>
  const categorySelect = document.getElementById('category-select');
  const classSelect = document.getElementById('component-class-select');

  function togglePieceClass() {
    const isPiece = categorySelect.value === 'Pe√ßa';
    classSelect.disabled = !isPiece;
    if (!isPiece) classSelect.value = '';
  }

  function toggleTechnicalFieldsByClass() {
    const selectedClass = classSelect.value;
    const fieldsMap = {
      memoria_ram: document.getElementById('ram-fields'),
      fonte: document.getElementById('psu-fields'),
      placa_video: document.getElementById('gpu-fields'),
      armazenamento: document.getElementById('storage-fields'),
    };

    Object.entries(fieldsMap).forEach(([key, fieldContainer]) => {
      if (!fieldContainer) return;
      const visible = selectedClass === key;
      fieldContainer.hidden = !visible;
      fieldContainer.querySelectorAll('input, select').forEach((input) => {
        if (!visible) input.value = '';
      });
    });
  }

  function parseMoneyValue(value) {
    const normalized = String(value || '')
      .replace(/\./g, '')
      .replace(',', '.')
      .replace(/[^\d.-]/g, '');
    const parsed = Number(normalized);
    return Number.isFinite(parsed) ? parsed : 0;
  }

  function calculateProfitMargin({ cost, freight, price }) {
    const totalCost = cost + freight;
    const profit = price - totalCost;

    if (price <= 0) return 0;
    return (profit / price) * 100;
  }

  function updateMarginRealtime() {
    const cost = parseMoneyValue(document.getElementById('cost-input')?.value || 0);
    const freight = parseMoneyValue(document.getElementById('freight-input')?.value || 0);
    const price = parseMoneyValue(document.getElementById('price-input')?.value || 0);
    const margin = calculateProfitMargin({ cost, freight, price });
    const marginInput = document.getElementById('margin-input');
    const pill = document.getElementById('margin-pill');
    if (marginInput) marginInput.value = margin.toFixed(2).replace('.', ',');
    if (!pill) return;
    pill.textContent = `${margin.toFixed(2).replace('.', ',')}%`;
    pill.classList.remove('ok','warn','bad');
    if (margin < 0) pill.classList.add('bad');
    else if (margin < 10) pill.classList.add('warn');
    else pill.classList.add('ok');
  }

  function scheduleMarginUpdate() {
    window.requestAnimationFrame(updateMarginRealtime);
  }

  categorySelect.addEventListener('change', togglePieceClass);
  classSelect.addEventListener('change', toggleTechnicalFieldsByClass);
  document.getElementById('cost-input')?.addEventListener('input', scheduleMarginUpdate);
  document.getElementById('freight-input')?.addEventListener('input', scheduleMarginUpdate);
  document.getElementById('price-input')?.addEventListener('input', scheduleMarginUpdate);
  togglePieceClass();
  toggleTechnicalFieldsByClass();
  updateMarginRealtime();
</script>
{% endblock %}
